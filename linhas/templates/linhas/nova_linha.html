{% extends 'base.html' %}

{% block title %}Nova Linha - Gestor de Linhas de Telefonia{% endblock %}

{% block content %}
<style>
    /* Header Tecnológico */
    .tech-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .tech-header h1 {
        color: #ffffff;
        font-weight: 700;
        font-size: 2rem;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Card Formulário */
    .form-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .form-card h5 {
        color: rgba(255,255,255,0.9);
        font-weight: 600;
        border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .form-label {
        color: rgba(255,255,255,0.9);
        font-weight: 600;
        font-size: 0.9rem;
    }
</style>

<div class="tech-header">
    <h1><i class="fas fa-plus"></i> Nova Linha</h1>
    <a href="{% url 'linhas:listalinhas' %}" class="btn btn-light">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="form-card">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    

                    <!-- AÇÃO -->
                    <h5 class="mt-4 mb-2"><i class="fas fa-map-marker-alt"></i> Ação</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.acao.id_for_label }}" class="form-label"></label>
                            <div class="d-flex align-items-center gap-2">
                                {{ form.acao }}
                                <!-- Botão removido, será exibido apenas na linha dos botões de ação -->
                            </div>
                            {% if form.acao.errors %}
                                <div class="text-danger small">{{ form.acao.errors.0 }}</div>
                            {% endif %}
                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    var acaoSelect = document.getElementById('{{ form.acao.id_for_label }}');
                                    var btnGerarTT = document.getElementById('btn-gerar-tt');
                                    function toggleGerarTT() {
                                        if (acaoSelect.value === 'TT') {
                                            btnGerarTT.style.display = '';
                                        } else {
                                            btnGerarTT.style.display = 'none';
                                        }
                                    }
                                    acaoSelect.addEventListener('change', toggleGerarTT);
                                    toggleGerarTT();
                                });
                            </script>
                        </div>
                        <div class="col-md-6 mb-3" id="linha-provisoria-group" style="display:none;">
                            <label for="linha-provisoria" class="form-label">
                                <i class="fas fa-search"></i> Pesquisar Linha Provisória (Estoque - RP: 7.1255217.10.11)
                            </label>
                            <input type="text" class="form-control" id="linha-provisoria" name="linha_provisoria" placeholder="Digite para buscar linha de estoque..." autocomplete="off">
                            <div id="provisoria-suggestions" class="list-group" style="position:absolute; z-index:1000;"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                            <i class="fas fa-sticky-note"></i> {{ form.observacoes.label }}
                        </label>
                        {{ form.observacoes }}
                        {% if form.observacoes.errors %}
                            <div class="text-danger small">{{ form.observacoes.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- FATURA -->
                    <h5 class="mt-4 mb-2"><i class="fas fa-building"></i> FATURA</h5>
                    
                    <!-- Campo de Busca Inteligente -->
                    <div class="mb-4">
                        <div class="col-md-12 position-relative">
                            <label for="busca-cliente-completa" class="form-label">
                                <i class="fas fa-search"></i> Buscar Cliente (Por Nome, CNPJ ou Número da Linha)
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" id="busca-cliente-completa" class="form-control" 
                                       placeholder="Digite o nome da empresa, CNPJ ou número da linha para autocompletar..." 
                                       autocomplete="off">
                                <button type="button" id="limpar-busca" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                            <div id="busca-resultado" class="alert alert-info mt-2" style="display:none;">
                                <i class="fas fa-info-circle"></i> <span id="busca-resultado-texto"></span>
                            </div>
                            <div id="busca-suggestions" class="list-group position-absolute w-100 mt-1" style="z-index:1000; display:none; max-height:240px; overflow:auto;"></div>
                        </div>
                    </div>
                    
                    <!-- Campos do Cliente (preenchidos automaticamente) -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.empresa.id_for_label }}" class="form-label small">
                                <i class="fas fa-building"></i> {{ form.empresa.label }} *
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-building"></i></span>
                                {{ form.empresa }}
                            </div>
                            {% if form.empresa.errors %}
                                <div class="text-danger small">{{ form.empresa.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.cnpj.id_for_label }}" class="form-label small">
                                <i class="fas fa-id-card"></i> {{ form.cnpj.label }} *
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                {{ form.cnpj }}
                            </div>
                            {% if form.cnpj.errors %}
                                <div class="text-danger small">{{ form.cnpj.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.taxa_manutencao.id_for_label }}" class="form-label">
                                <i class="fas fa-coins"></i> {{ form.taxa_manutencao.label }} *
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                {{ form.taxa_manutencao }}
                            </div>
                            {% if form.taxa_manutencao.errors %}
                                <div class="text-danger small">{{ form.taxa_manutencao.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="rp-select" class="form-label">
                                <i class="fas fa-user-tie"></i> RP *
                            </label>
                            <select class="form-select" id="rp-select" name="rp">
                                <option value="">Selecione um RP</option>
                                <option value="7.1255217.10.11">7.1255217.10.11 (ESTOQUE)</option>
                                <option value="novo">Novo RP</option>
                            </select>
                            <input type="text" class="form-control mt-2" id="rp-novo" name="rp_novo" placeholder="Digite novo RP" style="display:none;">
                            <small class="text-info" id="rp-auto-info" style="display:none;">
                                <i class="fas fa-info-circle"></i> RP selecionado automaticamente para movimentação de estoque/portabilidade
                            </small>
                            {% if form.rp.errors %}
                                <div class="text-danger small">{{ form.rp.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- LINHAS DINÂMICAS -->
                    <h5 class="mt-4 mb-2"><i class="fas fa-mobile-alt"></i> Linhas</h5>
                    <div id="linhas-dinamicas"></div>
                    <button type="button" class="btn btn-outline-success mb-3" id="adicionar-linha">
                        <i class="fas fa-plus"></i> Adicionar Linha
                    </button>
                    <template id="linha-template">
                        <div class="linha-grupo mb-4 border rounded p-3 position-relative">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-mobile-alt"></i> Número da Linha *</label>
                                    <input type="text" name="numero[]" class="form-control numero-linha" placeholder="(11) 99999-9999" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-tags"></i> Tipo de Plano *</label>
                                    <select name="tipo_plano[]" class="form-select tipo-plano-linha" required>
                                        <option value="">----------</option>
                                        <option value="BLACK_VOZ_GW_800SMS">BLACK VOZ + GW + 800SMS</option>
                                        <option value="BLACK_1GB_GW_800SMS">BLACK 1GB + GW + 800SMS</option>
                                        <option value="BLACK_5GB_GW_800SMS">BLACK 5GB + GW + 800SMS</option>
                                        <option value="BLACK_10GB_GW_800SMS">BLACK 10GB + GW + 800SMS</option>
                                        <option value="BLACK_20GB_GW_800SMS">BLACK 20GB + GW + 800SMS</option>
                                        <option value="BLACK_50GB_GW_800SMS">BLACK 50GB + GW + 800SMS</option>
                                        <option value="BLACK_ILIMITADO_GB_GW_800SMS">BLACK ILIMITADO GB + GW + 800SMS</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-dollar-sign"></i> Valor do Plano (R$) *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        <input type="text" name="valor_plano[]" class="form-control valor-plano-linha" readonly required>
                                    </div>
                                    <small class="text-muted">O valor será definido automaticamente pelo tipo de plano.</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-sim-card"></i> ICCID</label>
                                    <input type="text" name="iccid[]" class="form-control iccid-linha" placeholder="ICCID do chip">
                                </div>
                            </div>
                            <div class="row linha-portabilidade-row" style="display:none;">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label"><i class="fas fa-exchange-alt"></i> Linha a ser portada</label>
                                    <input type="text" name="linha_portada[]" class="form-control linha-portada" placeholder="Digite o número da linha a ser portada">
                                </div>
                            </div>
                        </div>
                    </template>
                    <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        var linhasDinamicas = document.getElementById('linhas-dinamicas');
                        var adicionarLinhaBtn = document.getElementById('adicionar-linha');
                        var linhaTemplate = document.getElementById('linha-template').content;
                        var valoresPlano = {
                            'BLACK_VOZ_GW_800SMS': '14.00',
                            'BLACK_1GB_GW_800SMS': '15.90',
                            'BLACK_5GB_GW_800SMS': '25.90',
                            'BLACK_10GB_GW_800SMS': '29.90',
                            'BLACK_20GB_GW_800SMS': '39.90',
                            'BLACK_50GB_GW_800SMS': '69.90',
                            'BLACK_ILIMITADO_GB_GW_800SMS': '164.00'
                        };
                        function addLinha() {
                            var clone = document.importNode(linhaTemplate, true);
                            linhasDinamicas.appendChild(clone);
                            atualizarEventos();
                        }
                        function atualizarEventos() {
                            var grupos = linhasDinamicas.querySelectorAll('.linha-grupo');
                            grupos.forEach(function(grupo) {
                                var tipoPlano = grupo.querySelector('.tipo-plano-linha');
                                var valorPlano = grupo.querySelector('.valor-plano-linha');
                                tipoPlano.addEventListener('change', function() {
                                    var tipo = tipoPlano.value;
                                    valorPlano.value = valoresPlano[tipo] || '';
                                });

                                // Mostrar/ocultar campo Linha a ser portada conforme ação principal
                                var linhaPortRow = grupo.querySelector('.linha-portabilidade-row');
                                var acaoPrincipal = document.getElementById('{{ form.acao.id_for_label }}');
                                function atualizarPortabilidade() {
                                    if (acaoPrincipal && acaoPrincipal.value === 'PORTABILIDADE') {
                                        linhaPortRow.style.display = '';
                                    } else {
                                        linhaPortRow.style.display = 'none';
                                    }
                                }
                                if (acaoPrincipal) {
                                    acaoPrincipal.addEventListener('change', atualizarPortabilidade);
                                    atualizarPortabilidade();
                                }
                            });
                        }
                        adicionarLinhaBtn.addEventListener('click', addLinha);
                        // Adiciona um grupo inicial
                        addLinha();

                        // Sistema de Busca Inteligente para Cliente
                        var buscaClienteInput = document.getElementById('busca-cliente-completa');
                        var buscaSuggestions = document.getElementById('busca-suggestions');
                        var buscaResultado = document.getElementById('busca-resultado');
                        var buscaResultadoTexto = document.getElementById('busca-resultado-texto');
                        var limparBuscaBtn = document.getElementById('limpar-busca');
                        
                        // Campos do formulário
                        var empresaInput = document.getElementById('{{ form.empresa.id_for_label }}');
                        var cnpjInput = document.getElementById('{{ form.cnpj.id_for_label }}');
                        var taxaInput = document.getElementById('{{ form.taxa_manutencao.id_for_label }}');
                        var rpSelect = document.getElementById('rp-select');
                        
                        var clienteAtualId = null;
                        var timeoutBusca = null;

                        // Função para limpar todos os campos
                        function limparCamposCliente() {
                            empresaInput.value = '';
                            cnpjInput.value = '';
                            if (taxaInput) taxaInput.value = '';
                            if (rpSelect) rpSelect.selectedIndex = 0;
                            clienteAtualId = null;
                            buscaResultado.style.display = 'none';
                            buscaSuggestions.style.display = 'none';
                        }

                        // Função para preencher campos com dados do cliente
                        function preencherDadosCliente(cliente, foundVia) {
                            empresaInput.value = cliente.empresa || '';
                            cnpjInput.value = cliente.cnpj || '';
                            if (taxaInput) taxaInput.value = cliente.valor_taxa_manutencao || '0.00';
                            
                            clienteAtualId = cliente.id;
                            
                            // Mostrar resultado da busca
                            buscaResultadoTexto.textContent = `Cliente encontrado via ${foundVia}: ${cliente.empresa}`;
                            buscaResultado.className = 'alert alert-success mt-2';
                            buscaResultado.style.display = 'block';
                            
                            buscaSuggestions.style.display = 'none';
                        }

                        // Event listener para busca inteligente
                        buscaClienteInput.addEventListener('input', function() {
                            var query = buscaClienteInput.value.trim();
                            
                            // Limpar timeout anterior
                            if (timeoutBusca) {
                                clearTimeout(timeoutBusca);
                            }
                            
                            if (query.length < 2) {
                                buscaSuggestions.style.display = 'none';
                                buscaResultado.style.display = 'none';
                                return;
                            }
                            
                            // Debounce - aguardar 300ms antes de fazer a busca
                            timeoutBusca = setTimeout(function() {
                                fetch('/linhas/buscar-cliente-completo/?q=' + encodeURIComponent(query))
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            // Cliente encontrado - preencher automaticamente
                                            preencherDadosCliente(data.cliente, data.found_via);
                                        } else {
                                            // Não encontrou - mostrar sugestões
                                            mostrarSugestoes(query);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Erro na busca:', error);
                                        mostrarSugestoes(query);
                                    });
                            }, 300);
                        });

                        // Função para mostrar sugestões de clientes
                        function mostrarSugestoes(query) {
                            fetch('/linhas/buscar-clientes/?q=' + encodeURIComponent(query))
                                .then(response => response.json())
                                .then(data => {
                                    buscaSuggestions.innerHTML = '';
                                    
                                    if (data && data.length > 0) {
                                        data.forEach(function(cliente) {
                                            var el = document.createElement('a');
                                            el.className = 'list-group-item list-group-item-action';
                                            el.innerHTML = `
                                                <div class="d-flex w-100 justify-content-between">
                                                    <h6 class="mb-1">${cliente.empresa}</h6>
                                                    <small>${cliente.cnpj || 'Sem CNPJ'}</small>
                                                </div>
                                                <p class="mb-1">${cliente.fantasia || cliente.razao_social || ''}</p>
                                            `;
                                            el.onclick = function() {
                                                preencherDadosCliente(cliente, 'seleção manual');
                                                buscaClienteInput.value = cliente.empresa;
                                            };
                                            buscaSuggestions.appendChild(el);
                                        });
                                        buscaSuggestions.style.display = 'block';
                                        
                                        // Mostrar mensagem de "não encontrado diretamente"
                                        buscaResultadoTexto.textContent = `Nenhum resultado direto. ${data.length} sugestão(ões) disponível(eis) abaixo.`;
                                        buscaResultado.className = 'alert alert-warning mt-2';
                                        buscaResultado.style.display = 'block';
                                    } else {
                                        buscaSuggestions.style.display = 'none';
                                        buscaResultadoTexto.textContent = 'Nenhum cliente encontrado. Certifique-se de cadastrar o cliente antes de criar a linha.';
                                        buscaResultado.className = 'alert alert-danger mt-2';
                                        buscaResultado.style.display = 'block';
                                    }
                                })
                                .catch(error => {
                                    console.error('Erro ao buscar sugestões:', error);
                                    buscaSuggestions.style.display = 'none';
                                });
                        }

                        // Botão limpar
                        limparBuscaBtn.addEventListener('click', function() {
                            buscaClienteInput.value = '';
                            limparCamposCliente();
                        });

                        // Fechar sugestões ao clicar fora
                        document.addEventListener('click', function(e) {
                            if (!buscaClienteInput.contains(e.target) && !buscaSuggestions.contains(e.target)) {
                                buscaSuggestions.style.display = 'none';
                            }
                        });

                    });
                    </script>
                    
                    

                    <div class="d-flex justify-content-end gap-2 align-items-center">
                        <a href="{% url 'linhas:listalinhas' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                        <button type="button" id="btn-gerar-tt" class="btn btn-outline-primary" style="display:none;">Gerar TT</button>
                        <button type="button" id="btn-gerar-termo" class="btn btn-outline-info" style="display:none;">Gerar Termo</button>
                        <button type="button" id="btn-gerar-tabela" class="btn btn-outline-warning" style="display:none;">Gerar Tabela</button>
                        <button type="button" id="btn-enviar-pedido" class="btn btn-success">Enviar Pedido</button>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            var acaoSelect = document.getElementById('{{ form.acao.id_for_label }}');
                            var btnGerarTT = document.getElementById('btn-gerar-tt');
                            var btnGerarTermo = document.getElementById('btn-gerar-termo');
                            var btnGerarTabela = document.getElementById('btn-gerar-tabela');
                            function toggleBotoes() {
                                if (acaoSelect.value === 'TT') {
                                    btnGerarTT.style.display = '';
                                    btnGerarTermo.style.display = 'none';
                                    btnGerarTabela.style.display = 'none';
                                } else if (acaoSelect.value === 'PORTABILIDADE') {
                                    btnGerarTT.style.display = 'none';
                                    btnGerarTermo.style.display = '';
                                    btnGerarTabela.style.display = '';
                                } else {
                                    btnGerarTT.style.display = 'none';
                                    btnGerarTermo.style.display = 'none';
                                    btnGerarTabela.style.display = 'none';
                                }
                            }
                            acaoSelect.addEventListener('change', toggleBotoes);
                            toggleBotoes();
                        });
                    </script>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            var acaoSelect = document.getElementById('{{ form.acao.id_for_label }}');
                            var btnGerarTT = document.getElementById('btn-gerar-tt');
                            function toggleGerarTT() {
                                if (acaoSelect.value === 'TT') {
                                    btnGerarTT.style.display = '';
                                } else {
                                    btnGerarTT.style.display = 'none';
                                }
                            }
                            acaoSelect.addEventListener('change', toggleGerarTT);
                            toggleGerarTT();
                        });
                    </script>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            var origemSelect = document.getElementById('{{ form.acao.id_for_label }}');
                            var provisoriaGroup = document.getElementById('linha-provisoria-group');
                            var provisoriaInput = document.getElementById('linha-provisoria');
                            var suggestionsBox = document.getElementById('provisoria-suggestions');
                            var numeroInput = document.getElementById('{{ form.numero.id_for_label }}');
                            var tipoPlanoSelect = document.getElementById('{{ form.tipo_plano.id_for_label }}');
                            var valorPlanoInput = document.getElementById('{{ form.valor_plano.id_for_label }}');
                            var cnpjInput = document.getElementById('{{ form.cnpj.id_for_label }}');
                            var empresaInput = document.getElementById('{{ form.empresa.id_for_label }}');
                            var rpSelect = document.getElementById('rp-select');
                            var rpNovo = document.getElementById('rp-novo');

                            function atualizarRPs() {
                                var cnpj = cnpjInput.value.replace(/\D/g, '');
                                var empresa = empresaInput.value;
                                if (cnpj.length >= 11 && empresa.length > 0) {
                                    fetch('/linhas/listar-rps-cliente/?cnpj=' + encodeURIComponent(cnpj) + '&empresa=' + encodeURIComponent(empresa))
                                        .then(response => response.json())
                                        .then(data => {
                                            rpSelect.innerHTML = '<option value="">Selecione um RP</option><option value="novo">Novo RP</option>';
                                            if (data.length > 0) {
                                                data.forEach(function(rp) {
                                                    var el = document.createElement('option');
                                                    el.value = rp;
                                                    el.textContent = rp;
                                                    rpSelect.appendChild(el);
                                                });
                                            }
                                        });
                                }
                            }
                            empresaInput.addEventListener('change', atualizarRPs);
                            cnpjInput.addEventListener('change', atualizarRPs);

                            rpSelect.addEventListener('change', function() {
                                if (rpSelect.value === 'novo') {
                                    rpNovo.style.display = '';
                                } else {
                                    rpNovo.style.display = 'none';
                                }
                            });
                            var cnpjSuggestions = document.getElementById('cnpj-suggestions');

                            // Autocomplete CNPJ
                            cnpjInput.addEventListener('input', function() {
                                var query = cnpjInput.value.replace(/\D/g, '');
                                if (query.length >= 5) {
                                    fetch('/linhas/autocomplete-cnpj/?q=' + encodeURIComponent(query))
                                        .then(response => response.json())
                                        .then(data => {
                                            cnpjSuggestions.innerHTML = '';
                                            if (data.length > 0) {
                                                data.forEach(function(item) {
                                                    var el = document.createElement('a');
                                                    el.className = 'list-group-item list-group-item-action';
                                                    el.textContent = item.cnpj + ' - ' + item.empresa;
                                                    el.onclick = function() {
                                                        cnpjInput.value = item.cnpj;
                                                        empresaInput.value = item.empresa;
                                                        cnpjSuggestions.style.display = 'none';
                                                    };
                                                    cnpjSuggestions.appendChild(el);
                                                });
                                                cnpjSuggestions.style.display = '';
                                            } else {
                                                cnpjSuggestions.style.display = 'none';
                                            }
                                        });
                                } else {
                                    cnpjSuggestions.style.display = 'none';
                                }
                            });
                            document.addEventListener('click', function(e) {
                                if (!cnpjInput.contains(e.target)) {
                                    cnpjSuggestions.style.display = 'none';
                                }
                            });

                            // Mapeamento dos valores por tipo de plano
                            var valoresPlano = {
                                'BLACK_VOZ_GW_800SMS': '14.00',
                                'BLACK_1GB_GW_800SMS': '15.90',
                                'BLACK_5GB_GW_800SMS': '25.90',
                                'BLACK_10GB_GW_800SMS': '29.90',
                                'BLACK_20GB_GW_800SMS': '39.90',
                                'BLACK_50GB_GW_800SMS': '69.90',
                                'BLACK_ILIMITADO_GB_GW_800SMS': '164.00'
                            };

                            function atualizarValorPlano() {
                                var tipo = tipoPlanoSelect.value;
                                if (valoresPlano[tipo]) {
                                    valorPlanoInput.value = valoresPlano[tipo];
                                    valorPlanoInput.readOnly = true;
                                } else {
                                    valorPlanoInput.value = '';
                                    valorPlanoInput.readOnly = false;
                                }
                            }
                            tipoPlanoSelect.addEventListener('change', atualizarValorPlano);
                            atualizarValorPlano();

                            function toggleProvisoria() {
                                if (origemSelect.value === 'PORTABILIDADE') {
                                    provisoriaGroup.style.display = '';
                                } else {
                                    provisoriaGroup.style.display = 'none';
                                    suggestionsBox.style.display = 'none';
                                }
                            }
                            origemSelect.addEventListener('change', toggleProvisoria);
                            toggleProvisoria();

                            provisoriaInput.addEventListener('input', function() {
                                var empresa = document.getElementById('{{ form.empresa.id_for_label }}').value;
                                var query = provisoriaInput.value;
                                if (origemSelect.value === 'PORTABILIDADE' && query.length > 1) {
                                    fetch('/linhas/buscar-linhas-estoque/?q=' + encodeURIComponent(query) + '&empresa=' + encodeURIComponent(empresa))
                                        .then(response => response.json())
                                        .then(data => {
                                            suggestionsBox.innerHTML = '';
                                            if (data.length > 0) {
                                                data.forEach(function(item) {
                                                    var el = document.createElement('a');
                                                    el.className = 'list-group-item list-group-item-action';
                                                    el.textContent = item.numero + ' (ICCID: ' + item.iccid + ')';
                                                    el.onclick = function() {
                                                        provisoriaInput.value = item.numero;
                                                        suggestionsBox.style.display = 'none';
                                                    };
                                                    suggestionsBox.appendChild(el);
                                                });
                                                suggestionsBox.style.display = '';
                                            } else {
                                                suggestionsBox.style.display = 'none';
                                            }
                                        });
                                } else {
                                    suggestionsBox.style.display = 'none';
                                }
                            });
                            document.addEventListener('click', function(e) {
                                if (!provisoriaGroup.contains(e.target)) {
                                    suggestionsBox.style.display = 'none';
                                }
                            });

                            // Validação JS para número da linha
                            numeroInput.addEventListener('input', function() {
                                var valor = numeroInput.value.replace(/\D/g, '');
                                if (valor.length !== 11) {
                                    numeroInput.setCustomValidity('O número da linha deve conter exatamente 11 dígitos.');
                                } else {
                                    numeroInput.setCustomValidity('');
                                }
                            });
                        });
                    </script>
                </form>
        </div>
    </div>

    <div class="col-md-4 d-flex align-items-start">
        <div class="form-card w-100">
                <div id="acao-observacao-area" style="display:none;">
                    <div class="mb-3" id="texto-observacao"></div>
                    <div id="anexo-area" style="display:none;">
                        <h5><i class="fas fa-paperclip"></i> Anexar Arquivos</h5>
                        <input type="file" name="anexos" class="form-control" multiple><br><br>
                    </div>
                </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var acaoPrincipal = document.getElementById('{{ form.acao.id_for_label }}');
        var obsArea = document.getElementById('acao-observacao-area');
        var textoObs = document.getElementById('texto-observacao');
        var anexoArea = document.getElementById('anexo-area');
        function atualizarObsArea() {
            if (acaoPrincipal) {
                // Configurar RP automaticamente para ESTOQUE e PORTABILIDADE
                var rpSelect = document.getElementById('rp-select');
                var rpAutoInfo = document.getElementById('rp-auto-info');
                
                if (acaoPrincipal.value === 'ESTOQUE' || acaoPrincipal.value === 'PORTABILIDADE') {
                    if (rpSelect) {
                        rpSelect.value = '7.1255217.10.11';
                    }
                    if (rpAutoInfo) {
                        rpAutoInfo.style.display = 'block';
                    }
                } else {
                    if (rpAutoInfo) {
                        rpAutoInfo.style.display = 'none';
                    }
                }
                
                if (acaoPrincipal.value === 'TT') {
                    obsArea.style.display = '';
                    textoObs.innerHTML = '<i class="fas fa-info-circle"></i> Insira o documento pessoal do titular da linha a ser transferida e o documento de Transferência de Titularidade - TT assinada.';
                    anexoArea.style.display = '';
                    // Adiciona segunda observação e botão abaixo
                        if (!document.getElementById('cliente-cadastro-area')) {
                        var clienteDiv = document.createElement('div');
                        clienteDiv.id = 'cliente-cadastro-area';
                        clienteDiv.innerHTML = '<span class="text-secondary">Caso o cliente não possua fatura ainda, primeiro cadastre o cliente e depois de andamento com a movimentação da linha.</span><br><a href="' + "{% url 'linhas:cliente_novo' %}" + '" class="btn btn-outline-primary mt-2"><i class="fas fa-user-plus"></i> Novo cadastro de cliente</a>';
                        obsArea.appendChild(clienteDiv);
                    }
                } else if (acaoPrincipal.value === 'PORTABILIDADE') {
                    obsArea.style.display = '';
                    textoObs.innerHTML = '<i class="fas fa-info-circle"></i> Insira o documento do titular da linha a ser portada, o termo de portabilidade e a tabela excel da portabilidade.';
                    anexoArea.style.display = '';
                        if (!document.getElementById('cliente-cadastro-area')) {
                        var clienteDiv = document.createElement('div');
                        clienteDiv.id = 'cliente-cadastro-area';
                        clienteDiv.innerHTML = '<span class="text-secondary">Caso o cliente não possua fatura ainda, primeiro cadastre o cliente e depois de andamento com a movimentação da linha.</span><br><a href="' + "{% url 'linhas:cliente_novo' %}" + '" class="btn btn-outline-primary mt-2"><i class="fas fa-user-plus"></i> Novo cadastro de cliente</a>';
                        obsArea.appendChild(clienteDiv);
                    }
                } else if (acaoPrincipal.value === 'ESTOQUE') {
                    obsArea.style.display = '';
                    textoObs.innerHTML = '';
                    anexoArea.style.display = 'none';
                        if (!document.getElementById('cliente-cadastro-area')) {
                        var clienteDiv = document.createElement('div');
                        clienteDiv.id = 'cliente-cadastro-area';
                        clienteDiv.innerHTML = '<i class="fas fa-info-circle"></i> Caso o cliente não possua fatura ainda, primeiro cadastre o cliente e depois de andamento com a movimentação da linha.<br><a href="' + "{% url 'linhas:cliente_novo' %}" + '" class="btn btn-outline-primary mt-2"><i class="fas fa-user-plus"></i> Novo cadastro de cliente</a>';
                        obsArea.appendChild(clienteDiv);
                    }
                } else {
                    obsArea.style.display = 'none';
                    textoObs.innerHTML = '';
                    anexoArea.style.display = 'none';
                    var clienteDiv = document.getElementById('cliente-cadastro-area');
                    if (clienteDiv) clienteDiv.remove();
                }
            }
        }
        if (acaoPrincipal) {
            acaoPrincipal.addEventListener('change', atualizarObsArea);
            atualizarObsArea();
        }
    });
    </script>
</div>
{% endblock %}

<!-- Modal para cadastro rápido de Cliente -->
<div class="modal fade" id="clienteModal" tabindex="-1" aria-labelledby="clienteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clienteModalLabel">Novo cadastro de cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="cliente-modal-errors" class="alert alert-danger d-none"></div>
                <form id="cliente-modal-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CNPJ</label>
                            <input type="text" name="cnpj" id="modal-cnpj" class="form-control" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Empresa (Nome)</label>
                            <input type="text" name="empresa" id="modal-empresa" class="form-control">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Razão Social</label>
                            <input type="text" name="razao_social" id="modal-razao" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome Fantasia</label>
                            <input type="text" name="fantasia" id="modal-fantasia" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Endereço completo</label>
                        <textarea name="endereco_completo" id="modal-endereco" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome do Titular / Dono</label>
                            <input type="text" name="nome_dono" id="modal-nome-dono" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">CPF do Dono</label>
                            <input type="text" name="cpf_dono" id="modal-cpf-dono" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Data de Nascimento</label>
                            <input type="date" name="data_nascimento_dono" id="modal-data-nasc" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="cliente-modal-save" class="btn btn-primary">Salvar cliente</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
        // Delegate click to open modal. Accept button with class or legacy anchor to /clientes/novo/
        document.body.addEventListener('click', function(e) {
                try {
                    var trigger = null;
                    if (e.target && (e.target.classList && (e.target.classList.contains('btn-open-cliente-modal') || e.target.closest && e.target.closest('.btn-open-cliente-modal')))) {
                        trigger = e.target.closest ? e.target.closest('.btn-open-cliente-modal') || e.target : e.target;
                    } else {
                        // also accept anchors that point to the legacy page
                        var a = e.target.closest ? e.target.closest('a[href]') : null;
                        if (a && a.getAttribute('href') && a.getAttribute('href').indexOf('/clientes/novo') !== -1) {
                            trigger = a;
                        }
                    }
                    if (trigger) {
                        e.preventDefault();
                        var modalEl = document.getElementById('clienteModal');
                        var clienteModal = new bootstrap.Modal(modalEl);
                        // clear previous errors
                        document.getElementById('cliente-modal-errors').classList.add('d-none');
                        document.getElementById('cliente-modal-errors').innerHTML = '';
                        // open
                        clienteModal.show();
                    }
                } catch (err) {
                    // swallow any errors in delegation to avoid breaking the page
                    console.error(err);
                }
        });

        function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                                const cookie = cookies[i].trim();
                                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                }
                        }
                }
                return cookieValue;
        }

        document.getElementById('cliente-modal-save').addEventListener('click', function() {
                var url = "{% url 'linhas:cliente_create_ajax' %}";
                var form = document.getElementById('cliente-modal-form');
                var fd = new FormData(form);
                // send fetch
                // Attempt to fetch CNPJ data before submitting if modal CNPJ filled (try BrasilAPI)
                var modalCnpjRaw = document.getElementById('modal-cnpj').value || '';
                var modalCnpjDigits = modalCnpjRaw.replace(/\D/g, '');
                if (modalCnpjDigits.length === 14) {
                    // usar nossa API interna em vez da externa
                    fetch('/linhas/buscar-cnpj-api/?cnpj=' + modalCnpjDigits)
                        .then(r => r.json()).then(result => {
                            try {
                                if (result.success && result.dados) {
                                    var data = result.dados;
                                    if (data.razao_social) document.getElementById('modal-razao').value = data.razao_social || document.getElementById('modal-razao').value;
                                    if (data.fantasia) document.getElementById('modal-fantasia').value = data.fantasia || document.getElementById('modal-fantasia').value;
                                    if (data.endereco) {
                                        var endereco = '';
                                        var endParts = [];
                                        if (data.endereco) endParts.push(data.endereco);
                                        if (data.numero) endParts.push(data.numero);
                                        if (data.complemento) endParts.push(data.complemento);
                                        if (data.bairro) endParts.push(data.bairro);
                                        if (data.municipio) endParts.push(data.municipio);
                                        if (data.uf) endParts.push(data.uf);
                                        if (data.cep) endParts.push('CEP: ' + data.cep);
                                        endereco = endParts.join(', ');
                                        document.getElementById('modal-endereco').value = endereco;
                                    }
                                }
                            } catch (err) {
                                // ignore
                            }
                        }).catch(() => {});
                }

                fetch(url, {
                        method: 'POST',
                        headers: {
                                'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: fd,
                        credentials: 'same-origin'
                }).then(r => r.json().then(body => ({status: r.status, body}))).then(resp => {
                        if (resp.status >= 200 && resp.status < 300 && resp.body.success) {
                                // success: fill empresa/cnpj in main form
                                var empresaInput = document.getElementById('{{ form.empresa.id_for_label }}');
                                var cnpjInput = document.getElementById('{{ form.cnpj.id_for_label }}');
                                if (empresaInput) empresaInput.value = resp.body.cliente.empresa || '';
                                if (cnpjInput) cnpjInput.value = resp.body.cliente.cnpj || '';
                                // hide modal
                                var modalEl = document.getElementById('clienteModal');
                                var clienteModal = bootstrap.Modal.getInstance(modalEl);
                                if (clienteModal) clienteModal.hide();
                        } else {
                                // show errors
                                var errBox = document.getElementById('cliente-modal-errors');
                                errBox.classList.remove('d-none');
                                var msgs = [];
                                if (resp.body && resp.body.errors) {
                                        for (var k in resp.body.errors) {
                                                msgs.push('<strong>' + k + '</strong>: ' + resp.body.errors[k]);
                                        }
                                } else if (resp.body && resp.body.body) {
                                        msgs.push(JSON.stringify(resp.body.body));
                                } else {
                                        msgs.push('Erro desconhecido ao salvar cliente.');
                                }
                                errBox.innerHTML = msgs.join('<br>');
                        }
                }).catch(err => {
                        var errBox = document.getElementById('cliente-modal-errors');
                        errBox.classList.remove('d-none');
                        errBox.innerHTML = 'Erro de rede ao tentar salvar o cliente.';
                });
        });
});
</script>

    <!-- Tom Select + Cleave.js (masks) -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // initialize Tom Select on cliente-select
        try {
            new TomSelect('#cliente-select', {
                valueField: 'id',
                labelField: 'empresa',
                searchField: ['empresa','cnpj','fantasia','razao_social'],
                placeholder: 'Pesquisar clientes por nome ou CNPJ...',
                load: function(query, callback) {
                    if (!query.length) return callback();
                    fetch('/linhas/buscar-clientes/?q=' + encodeURIComponent(query))
                        .then(r => r.json())
                        .then(data => { callback(data); })
                        .catch(() => { callback(); });
                },
                onChange: function(value) {
                    // when a client is selected, fetch its details and fill fields
                    if (!value) return;
                    fetch('/linhas/buscar-clientes/?q=' + encodeURIComponent(value))
                        .then(r => r.json())
                        .then(data => {
                            var sel = data.find(d => d.id == value) || data[0] || null;
                            if (sel) {
                                var empresaInput = document.getElementById('{{ form.empresa.id_for_label }}');
                                var cnpjInput = document.getElementById('{{ form.cnpj.id_for_label }}');
                                if (empresaInput) empresaInput.value = sel.empresa || '';
                                if (cnpjInput) cnpjInput.value = sel.cnpj || '';
                                // optionally fill taxa_manutencao or rp if you store them on Cliente
                            }
                        });
                }
            });
        } catch (e) { /* ignore if TomSelect not available */ }

        // apply masks with Cleave.js (robust selectors + re-init on paste/focus)
        try {
            function findEl(selectorList) {
                for (var i = 0; i < selectorList.length; i++) {
                    var el = document.querySelector(selectorList[i]);
                    if (el) return el;
                }
                return null;
            }

            var modalCnpj = findEl(['#modal-cnpj', 'input[name="modal-cnpj"]', 'input[id$="modal-cnpj"]']);
            var mainCnpj = findEl(['#{{ form.cnpj.id_for_label }}', 'input[name="cnpj"]', 'input[id$="cnpj"]']);
            var modalCpf = findEl(['#modal-cpf-dono', 'input[name="cpf_dono"]', 'input[id$="cpf_dono"]']);

            function initCnpjMask(el) {
                if (!el) return null;
                try {
                    var mask = new Cleave(el, { delimiters: ['.','.','/','-'], blocks: [2,3,3,4,2], numericOnly: true });
                    el.addEventListener('paste', function() { setTimeout(function(){ try{ mask.destroy(); mask = new Cleave(el, { delimiters: ['.','.','/','-'], blocks: [2,3,3,4,2], numericOnly: true }); }catch(e){} }, 50); });
                    el.addEventListener('focus', function(){ try{ if(!el._cleave){ mask = new Cleave(el, { delimiters: ['.','.','/','-'], blocks: [2,3,3,4,2], numericOnly: true }); } }catch(e){} });
                    return mask;
                } catch (e) { return null; }
            }

            function initCpfMask(el) {
                if (!el) return null;
                try {
                    var mask = new Cleave(el, { delimiters: ['.','.','-'], blocks: [3,3,3,2], numericOnly: true });
                    el.addEventListener('paste', function() { setTimeout(function(){ try{ mask.destroy(); mask = new Cleave(el, { delimiters: ['.','.','-'], blocks: [3,3,3,2], numericOnly: true }); }catch(e){} }, 50); });
                    return mask;
                } catch (e) { return null; }
            }

            initCnpjMask(modalCnpj);
            initCnpjMask(mainCnpj);
            initCpfMask(modalCpf);

            // Also ensure formatting while typing: if Cleave isn't active, format input on input event
            if (mainCnpj) {
                mainCnpj.addEventListener('input', function() {
                    try {
                        // allow Cleave to handle it if present; otherwise format manually
                        if (window.Cleave && mainCnpj._cleave) return;
                        var v = mainCnpj.value.replace(/\D/g, '').slice(0,14);
                        if (!v) { mainCnpj.value = ''; return; }
                        var parts = [];
                        parts.push(v.slice(0,2));
                        if (v.length > 2) parts.push(v.slice(2,5));
                        if (v.length > 5) parts.push(v.slice(5,8));
                        if (v.length > 8) parts.push(v.slice(8,12));
                        if (v.length > 12) parts.push(v.slice(12,14));
                        var out = '';
                        if (parts.length >= 1) out = parts[0];
                        if (parts.length >= 2) out += '.' + parts[1];
                        if (parts.length >= 3) out += '.' + parts[2];
                        if (parts.length >= 4) out += '/' + parts[3];
                        if (parts.length >= 5) out += '-' + parts[4];
                        mainCnpj.value = out;
                    } catch (e) { console.warn('manual cnpj format failed', e); }
                });
            }
        } catch (e) { /* ignore */ }
    });
    </script>

