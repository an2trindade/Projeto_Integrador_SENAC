{% extends 'base.html' %}

{% block title %}Nova Linha - Gestor de Linhas de Telefonia{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-plus"></i> Nova Linha de Telefonia</h1>
    <a href="{% url 'linhas:listalinhas' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    


                    <!-- CLIENTE -->
                    <h5 class="mt-4 mb-2"><i class="fas fa-building"></i> FATURA</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.empresa.id_for_label }}" class="form-label">
                                <i class="fas fa-building"></i> {{ form.empresa.label }} *
                            </label>
                            {{ form.empresa }}
                            {% if form.empresa.errors %}
                                <div class="text-danger small">{{ form.empresa.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3" style="position:relative;">
                            <label for="{{ form.cnpj.id_for_label }}" class="form-label">
                                <i class="fas fa-id-card"></i> {{ form.cnpj.label }} *
                            </label>
                            {{ form.cnpj }}
                            <div id="cnpj-suggestions" class="list-group" style="position:absolute; z-index:1000;"></div>
                            {% if form.cnpj.errors %}
                                <div class="text-danger small">{{ form.cnpj.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.taxa_manutencao.id_for_label }}" class="form-label">
                                <i class="fas fa-coins"></i> {{ form.taxa_manutencao.label }} *
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                {{ form.taxa_manutencao }}
                            </div>
                            {% if form.taxa_manutencao.errors %}
                                <div class="text-danger small">{{ form.taxa_manutencao.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="rp-select" class="form-label">
                                <i class="fas fa-user-tie"></i> RP *
                            </label>
                            <select class="form-select" id="rp-select" name="rp">
                                <option value="">Selecione um RP</option>
                                <option value="novo">Novo RP</option>
                            </select>
                            <input type="text" class="form-control mt-2" id="rp-novo" name="rp_novo" placeholder="Digite novo RP" style="display:none;">
                            {% if form.rp.errors %}
                                <div class="text-danger small">{{ form.rp.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- LINHA -->
                    <h5 class="mt-4 mb-2"><i class="fas fa-mobile-alt"></i> Linha</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.numero.id_for_label }}" class="form-label">
                                <i class="fas fa-mobile-alt"></i> {{ form.numero.label }} *
                            </label>
                            {{ form.numero }}
                            {% if form.numero.errors %}
                                <div class="text-danger small">{{ form.numero.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.tipo_plano.id_for_label }}" class="form-label">
                                <i class="fas fa-tags"></i> {{ form.tipo_plano.label }} *
                            </label>
                            {{ form.tipo_plano }}
                            {% if form.tipo_plano.errors %}
                                <div class="text-danger small">{{ form.tipo_plano.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.valor_plano.id_for_label }}" class="form-label">
                                <i class="fas fa-dollar-sign"></i> {{ form.valor_plano.label }} *
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control" id="{{ form.valor_plano.id_for_label }}" name="{{ form.valor_plano.html_name }}" value="{{ form.valor_plano.value }}" readonly>
                            </div>
                            <small class="text-muted">O valor será definido automaticamente pelo tipo de plano.</small>
                            {% if form.valor_plano.errors %}
                                <div class="text-danger small">{{ form.valor_plano.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.iccid.id_for_label }}" class="form-label">
                                <i class="fas fa-sim-card"></i> {{ form.iccid.label }} *
                            </label>
                            {{ form.iccid }}
                            {% if form.iccid.errors %}
                                <div class="text-danger small">{{ form.iccid.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- AÇÃO -->
                    <h5 class="mt-4 mb-2"><i class="fas fa-map-marker-alt"></i> Ação</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.acao.id_for_label }}" class="form-label">
                                <i class="fas fa-map-marker-alt"></i> {{ form.acao.label }} *
                            </label>
                            {{ form.acao }}
                            {% if form.acao.errors %}
                                <div class="text-danger small">{{ form.acao.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3" id="linha-provisoria-group" style="display:none;">
                            <label for="linha-provisoria" class="form-label">
                                <i class="fas fa-search"></i> Pesquisar Linha Provisória (Estoque)
                            </label>
                            <input type="text" class="form-control" id="linha-provisoria" name="linha_provisoria" placeholder="Digite para buscar..." autocomplete="off">
                            <div id="provisoria-suggestions" class="list-group" style="position:absolute; z-index:1000;"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                            <i class="fas fa-sticky-note"></i> {{ form.observacoes.label }}
                        </label>
                        {{ form.observacoes }}
                        {% if form.observacoes.errors %}
                            <div class="text-danger small">{{ form.observacoes.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a href="{% url 'linhas:listalinhas' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            var origemSelect = document.getElementById('{{ form.acao.id_for_label }}');
                            var provisoriaGroup = document.getElementById('linha-provisoria-group');
                            var provisoriaInput = document.getElementById('linha-provisoria');
                            var suggestionsBox = document.getElementById('provisoria-suggestions');
                            var numeroInput = document.getElementById('{{ form.numero.id_for_label }}');
                            var tipoPlanoSelect = document.getElementById('{{ form.tipo_plano.id_for_label }}');
                            var valorPlanoInput = document.getElementById('{{ form.valor_plano.id_for_label }}');
                            var cnpjInput = document.getElementById('{{ form.cnpj.id_for_label }}');
                            var empresaInput = document.getElementById('{{ form.empresa.id_for_label }}');
                            var rpSelect = document.getElementById('rp-select');
                            var rpNovo = document.getElementById('rp-novo');

                            function atualizarRPs() {
                                var cnpj = cnpjInput.value.replace(/\D/g, '');
                                var empresa = empresaInput.value;
                                if (cnpj.length >= 11 && empresa.length > 0) {
                                    fetch('/linhas/listar-rps-cliente/?cnpj=' + encodeURIComponent(cnpj) + '&empresa=' + encodeURIComponent(empresa))
                                        .then(response => response.json())
                                        .then(data => {
                                            rpSelect.innerHTML = '<option value="">Selecione um RP</option><option value="novo">Novo RP</option>';
                                            if (data.length > 0) {
                                                data.forEach(function(rp) {
                                                    var el = document.createElement('option');
                                                    el.value = rp;
                                                    el.textContent = rp;
                                                    rpSelect.appendChild(el);
                                                });
                                            }
                                        });
                                }
                            }
                            empresaInput.addEventListener('change', atualizarRPs);
                            cnpjInput.addEventListener('change', atualizarRPs);

                            rpSelect.addEventListener('change', function() {
                                if (rpSelect.value === 'novo') {
                                    rpNovo.style.display = '';
                                } else {
                                    rpNovo.style.display = 'none';
                                }
                            });
                            var cnpjSuggestions = document.getElementById('cnpj-suggestions');

                            // Autocomplete CNPJ
                            cnpjInput.addEventListener('input', function() {
                                var query = cnpjInput.value.replace(/\D/g, '');
                                if (query.length >= 5) {
                                    fetch('/linhas/autocomplete-cnpj/?q=' + encodeURIComponent(query))
                                        .then(response => response.json())
                                        .then(data => {
                                            cnpjSuggestions.innerHTML = '';
                                            if (data.length > 0) {
                                                data.forEach(function(item) {
                                                    var el = document.createElement('a');
                                                    el.className = 'list-group-item list-group-item-action';
                                                    el.textContent = item.cnpj + ' - ' + item.empresa;
                                                    el.onclick = function() {
                                                        cnpjInput.value = item.cnpj;
                                                        empresaInput.value = item.empresa;
                                                        cnpjSuggestions.style.display = 'none';
                                                    };
                                                    cnpjSuggestions.appendChild(el);
                                                });
                                                cnpjSuggestions.style.display = '';
                                            } else {
                                                cnpjSuggestions.style.display = 'none';
                                            }
                                        });
                                } else {
                                    cnpjSuggestions.style.display = 'none';
                                }
                            });
                            document.addEventListener('click', function(e) {
                                if (!cnpjInput.contains(e.target)) {
                                    cnpjSuggestions.style.display = 'none';
                                }
                            });

                            // Mapeamento dos valores por tipo de plano
                            var valoresPlano = {
                                'BLACK_VOZ_GW_800SMS': '14.00',
                                'BLACK_1GB_GW_800SMS': '15.90',
                                'BLACK_5GB_GW_800SMS': '25.90',
                                'BLACK_10GB_GW_800SMS': '29.90',
                                'BLACK_20GB_GW_800SMS': '39.90',
                                'BLACK_50GB_GW_800SMS': '69.90',
                                'BLACK_ILIMITADO_GB_GW_800SMS': '164.00'
                            };

                            function atualizarValorPlano() {
                                var tipo = tipoPlanoSelect.value;
                                if (valoresPlano[tipo]) {
                                    valorPlanoInput.value = valoresPlano[tipo];
                                    valorPlanoInput.readOnly = true;
                                } else {
                                    valorPlanoInput.value = '';
                                    valorPlanoInput.readOnly = false;
                                }
                            }
                            tipoPlanoSelect.addEventListener('change', atualizarValorPlano);
                            atualizarValorPlano();

                            function toggleProvisoria() {
                                if (origemSelect.value === 'PORTABILIDADE') {
                                    provisoriaGroup.style.display = '';
                                } else {
                                    provisoriaGroup.style.display = 'none';
                                    suggestionsBox.style.display = 'none';
                                }
                            }
                            origemSelect.addEventListener('change', toggleProvisoria);
                            toggleProvisoria();

                            provisoriaInput.addEventListener('input', function() {
                                var empresa = document.getElementById('{{ form.empresa.id_for_label }}').value;
                                var query = provisoriaInput.value;
                                if (origemSelect.value === 'PORTABILIDADE' && query.length > 1) {
                                    fetch('/linhas/buscar-linhas-estoque/?q=' + encodeURIComponent(query) + '&empresa=' + encodeURIComponent(empresa))
                                        .then(response => response.json())
                                        .then(data => {
                                            suggestionsBox.innerHTML = '';
                                            if (data.length > 0) {
                                                data.forEach(function(item) {
                                                    var el = document.createElement('a');
                                                    el.className = 'list-group-item list-group-item-action';
                                                    el.textContent = item.numero + ' (ICCID: ' + item.iccid + ')';
                                                    el.onclick = function() {
                                                        provisoriaInput.value = item.numero;
                                                        suggestionsBox.style.display = 'none';
                                                    };
                                                    suggestionsBox.appendChild(el);
                                                });
                                                suggestionsBox.style.display = '';
                                            } else {
                                                suggestionsBox.style.display = 'none';
                                            }
                                        });
                                } else {
                                    suggestionsBox.style.display = 'none';
                                }
                            });
                            document.addEventListener('click', function(e) {
                                if (!provisoriaGroup.contains(e.target)) {
                                    suggestionsBox.style.display = 'none';
                                }
                            });

                            // Validação JS para número da linha
                            numeroInput.addEventListener('input', function() {
                                var valor = numeroInput.value.replace(/\D/g, '');
                                if (valor.length !== 11) {
                                    numeroInput.setCustomValidity('O número da linha deve conter exatamente 11 dígitos.');
                                } else {
                                    numeroInput.setCustomValidity('');
                                }
                            });
                        });
                    </script>
                </form>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

