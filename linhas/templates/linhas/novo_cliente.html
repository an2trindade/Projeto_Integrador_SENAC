{% extends 'base.html' %}

{% block title %}Novo Cliente - Gestor de Linhas{% endblock %}

<!-- Fun√ß√£o JavaScript para bloquear caracteres inv√°lidos no CPF -->
<script>
function somenteNumerosCPF(event) {
    // Bloquear TUDO exceto n√∫meros e teclas especiais
    var char = String.fromCharCode(event.which || event.keyCode);
    var campo = event.target;
    
    // Contar n√∫meros atuais
    var numerosAtuais = campo.value.replace(/[^0-9]/g, '');
    
    // Teclas especiais permitidas (backspace, delete, setas, etc.)
    var teclasPermitidas = [8, 9, 13, 27, 35, 36, 37, 38, 39, 40, 46];
    if (teclasPermitidas.indexOf(event.keyCode) !== -1) {
        return true;
    }
    
    // Ctrl + teclas (copiar, colar, etc.)
    if (event.ctrlKey) {
        return true;
    }
    
    // Se √© um n√∫mero e n√£o ultrapassou 11 d√≠gitos
    if (/[0-9]/.test(char) && numerosAtuais.length < 11) {
        return true;
    }
    
    // Bloquear tudo o resto
    console.log('üö´ BLOQUEADO:', char, 'Atual:', numerosAtuais.length, 'd√≠gitos');
    event.preventDefault();
    return false;
}

function formatarCPFLimitado(campo) {
    if (!campo) return;
    
    // Salvar posi√ß√£o do cursor
    var cursorPos = campo.selectionStart;
    
    // Remover tudo que n√£o √© n√∫mero
    var somenteNumeros = campo.value.replace(/[^0-9]/g, '');
    
    // Limitar a 11 d√≠gitos
    somenteNumeros = somenteNumeros.substring(0, 11);
    
    // Aplicar apenas n√∫meros (sem formata√ß√£o)
    campo.value = somenteNumeros;
    
    // Tentar manter posi√ß√£o do cursor
    try {
        campo.setSelectionRange(cursorPos, cursorPos);
    } catch (e) {}
    
    console.log('CPF apenas n√∫meros:', somenteNumeros, 'Quantidade:', somenteNumeros.length);
}

function somenteNumerosContato(event) {
    var charCode = (event.which) ? event.which : event.keyCode;
    var campo = event.target;
    
    // Permitir: backspace, delete, tab, escape, enter
    if (charCode == 8 || charCode == 9 || charCode == 27 || charCode == 13 || charCode == 46) {
        return true;
    }
    
    // Permitir: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X, Ctrl+Z
    if (event.ctrlKey && (charCode == 65 || charCode == 67 || charCode == 86 || charCode == 88 || charCode == 90)) {
        return true;
    }
    
    // Permitir: Home, End, setas de navega√ß√£o
    if (charCode >= 35 && charCode <= 40) {
        return true;
    }
    
    // Se for um n√∫mero, verificar se j√° tem 11 d√≠gitos
    if ((charCode >= 48 && charCode <= 57) || (charCode >= 96 && charCode <= 105)) {
        var somenteNumeros = campo.value.replace(/[^0-9]/g, '');
        if (somenteNumeros.length >= 11) {
            console.log('Contato j√° tem 11 n√∫meros, bloqueando entrada');
            event.preventDefault();
            return false;
        }
        return true;
    }
    
    // Bloquear tudo o resto
    event.preventDefault();
    return false;
}

function formatarContatoLimitado(campo) {
    if (!campo) return;
    
    // Salvar posi√ß√£o do cursor
    var cursorPos = campo.selectionStart;
    
    // Remover tudo que n√£o √© n√∫mero
    var somenteNumeros = campo.value.replace(/[^0-9]/g, '');
    
    // Limitar a 11 d√≠gitos
    somenteNumeros = somenteNumeros.substring(0, 11);
    
    // Aplicar apenas n√∫meros (sem formata√ß√£o)
    campo.value = somenteNumeros;
    
    // Tentar manter posi√ß√£o do cursor
    try {
        campo.setSelectionRange(cursorPos, cursorPos);
    } catch (e) {}
    
    console.log('Contato apenas n√∫meros:', somenteNumeros, 'Quantidade:', somenteNumeros.length);
}

function bloqueiarLetrasContato(event) {
    var charCode = event.which || event.keyCode;
    
    console.log('Tecla pressionada:', charCode, 'Char:', String.fromCharCode(charCode));
    
    // Permitir teclas especiais (backspace, delete, tab, enter, escape, setas)
    if (charCode == 8 || charCode == 9 || charCode == 13 || charCode == 27 || charCode == 46 ||
        (charCode >= 35 && charCode <= 40)) {
        return true;
    }
    
    // Permitir Ctrl+comandos
    if (event.ctrlKey) {
        return true;
    }
    
    // Permitir apenas n√∫meros (0-9)
    if (charCode >= 48 && charCode <= 57) {
        // Verificar se j√° tem 11 n√∫meros
        var campo = event.target;
        var numeros = campo.value.replace(/[^0-9]/g, '');
        if (numeros.length >= 11) {
            console.log('BLOQUEADO: J√° tem 11 n√∫meros');
            event.preventDefault();
            return false;
        }
        console.log('PERMITIDO: N√∫mero', String.fromCharCode(charCode));
        return true;
    }
    
    // Permitir n√∫meros do teclado num√©rico
    if (charCode >= 96 && charCode <= 105) {
        // Verificar se j√° tem 11 n√∫meros
        var campo = event.target;
        var numeros = campo.value.replace(/[^0-9]/g, '');
        if (numeros.length >= 11) {
            console.log('BLOQUEADO: J√° tem 11 n√∫meros (numpad)');
            event.preventDefault();
            return false;
        }
        console.log('PERMITIDO: N√∫mero do numpad', String.fromCharCode(charCode));
        return true;
    }
    
    // Bloquear tudo o resto (letras, s√≠mbolos, etc.)
    console.log('BLOQUEADO: Caractere inv√°lido', String.fromCharCode(charCode));
    event.preventDefault();
    return false;
}

console.log('Fun√ß√µes CPF e Contato carregadas');
</script>

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-user-plus"></i> Novo Cliente</h1>
    <a href="{% url 'linhas:novalinha' %}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Voltar</a>
</div>

<!-- Formul√°rio com Abas -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-3">
        </div>
        
        <!-- Abas de Sele√ß√£o -->
        <ul class="nav nav-tabs card-header-tabs" id="tipoClienteTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-pessoa-juridica" data-bs-toggle="tab" data-bs-target="#conteudo-pj" type="button" role="tab">
                    <i class="fas fa-building me-2"></i>Pessoa Jur√≠dica
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-pessoa-fisica" data-bs-toggle="tab" data-bs-target="#conteudo-pf" type="button" role="tab">
                    <i class="fas fa-user me-2"></i>Pessoa F√≠sica
                </button>
            </li>
        </ul>
    </div>
    
    <div class="card-body">
        <!-- Conte√∫do das Abas -->
        <div class="tab-content" id="tipoClienteContent">
            
            <!-- Conte√∫do Pessoa Jur√≠dica -->
            <div class="tab-pane fade show active" id="conteudo-pj" role="tabpanel">
                <form method="post" id="form-cliente">
                    {% csrf_token %}
                    <input type="hidden" name="tipo_pessoa" value="juridica" id="input-tipo-pessoa">
                    
                    {% if cliente_salvo %}
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle"></i>
                        <strong>Opera√ß√£o Conclu√≠da!</strong> 
                        Cliente "{{ cliente_salvo.empresa }}" foi cadastrado com sucesso. 
                        Voc√™ pode cadastrar outro cliente ou criar uma linha para o cliente salvo.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}

                    <!-- Campos Pessoa Jur√≠dica -->
                    <div id="campos-pj">
                        <div class="mb-3 position-relative">
                            <label class="form-label small">CNPJ *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                {{ form.cnpj }}
                                <button type="button" class="btn btn-outline-secondary" id="btn-buscar-cnpj" title="Buscar dados por CNPJ">
                                    <i class="fas fa-search"></i> Buscar CNPJ
                                </button>
                            </div>
                            <div id="cnpj-alert" class="form-text text-danger mt-1" style="display:none;"></div>
                            {% if form.cnpj.errors %}<div class="text-danger small">{{ form.cnpj.errors.0 }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Raz√£o Social *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
                                {{ form.razao_social }}
                            </div>
                            {% if form.razao_social.errors %}<div class="text-danger small">{{ form.razao_social.errors.0 }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Nome Fantasia</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                {{ form.fantasia }}
                            </div>
                            {% if form.fantasia.errors %}<div class="text-danger small">{{ form.fantasia.errors.0 }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Nome do Propriet√°rio *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-user-tie"></i></span>
                                {{ form.nome_dono }}
                            </div>
                            {% if form.nome_dono.errors %}<div class="text-danger small">{{ form.nome_dono.errors.0 }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">CPF do Propriet√°rio *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                {{ form.cpf_dono }}
                            </div>
                            {% if form.cpf_dono.errors %}<div class="text-danger small">{{ form.cpf_dono.errors.0 }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Data de Nascimento do Propriet√°rio *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                {{ form.data_nascimento_dono }}
                            </div>
                            {% if form.data_nascimento_dono.errors %}<div class="text-danger small">{{ form.data_nascimento_dono.errors.0 }}</div>{% endif %}
                        </div>
                    </div>
                    

                    
                    <!-- Campos Comuns -->
                    <div id="campos-comuns">
                        <div class="mb-3">
                            <label class="form-label small">Endere√ßo Completo *</label>
                            <textarea name="endereco_completo" id="id_endereco_completo" class="form-control" rows="3" placeholder="Rua, n√∫mero, complemento, bairro, cidade, estado, CEP" required>{{ form.endereco_completo.value|default:'' }}</textarea>
                            {% if form.endereco_completo.errors %}<div class="text-danger small">{{ form.endereco_completo.errors.0 }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Contato Principal *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                <input type="text" name="contato" id="id_contato" class="form-control" placeholder="(11) 99999-9999" required value="{{ form.contato.value|default:'' }}">
                            </div>
                            {% if form.contato.errors %}<div class="text-danger small">{{ form.contato.errors.0 }}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">E-mail</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                <input type="email" name="email" id="id_email" class="form-control" placeholder="email@exemplo.com" value="{{ form.email.value|default:'' }}">
                            </div>
                            {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors.0 }}</div>{% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-secondary" onclick="history.back()">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                        
                        <div>
                            <button type="submit" name="next_action" value="stay" class="btn btn-success me-2">
                                <i class="fas fa-save"></i> Salvar e Continuar
                            </button>
                            <button type="submit" name="next_action" value="nova_linha" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Salvar e Criar Linha
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Conte√∫do Pessoa F√≠sica -->
            <div class="tab-pane fade" id="conteudo-pf" role="tabpanel">
                <form method="post" id="form-cliente-pf">
                    {% csrf_token %}
                    <input type="hidden" name="tipo_pessoa" value="fisica">
                    
                    <!-- Campos Pessoa F√≠sica -->
                    <div class="mb-3">
                        <label class="form-label small">Nome Completo *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                            <input type="text" name="nome_completo" id="id_nome_completo" class="form-control" placeholder="NOME COMPLETO" required
                                   style="text-transform: uppercase;" 
                                   oninput="this.value = this.value.toUpperCase()">
                        </div>
                    </div>

                        <div class="mb-3">
                        <label class="form-label small">CPF (somente n√∫meros)*</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                            <input type="text" name="cpf_pf" id="id_cpf_pf" class="form-control" placeholder="12345678901" required
                                   maxlength="11"
                                   pattern="[0-9]{11}"
                                   inputmode="numeric"
                                   autocomplete="off"
                                   onkeypress="return somenteNumerosCPF(event)"
                                   onkeydown="return somenteNumerosCPF(event)"
                                   oninput="formatarCPFLimitado(this); this.value = this.value.replace(/[^0-9]/g, '').substring(0, 11);"
                                   onpaste="setTimeout(function(){ var el = document.getElementById('id_cpf_pf'); el.value = el.value.replace(/[^0-9]/g, '').substring(0, 11); }, 10)"
                        </div>
                    </div>                    <div class="mb-3">
                        <label class="form-label small">Data de Nascimento *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                            <input type="date" name="data_nascimento_pf" id="id_data_nascimento_pf" class="form-control" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">Endere√ßo Completo *</label>
                        <textarea name="endereco_pf" id="id_endereco_pf" class="form-control" rows="3" placeholder="RUA - N√öMERO - COMPLEMENTO - BAIRRO - CIDADE - ESTADO - CEP" required
                                  style="text-transform: uppercase;" 
                                  oninput="this.value = this.value.toUpperCase()"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">Contato Principal (somentes n√∫meros) *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-phone"></i></span>
                            <input type="text" name="contato_pf" id="id_contato_pf" class="form-control" placeholder="11999999999" required
                                   maxlength="11"
                                   autocomplete="off"
                                   pattern="[0-9]{11}"
                                   inputmode="numeric"
                                   onkeypress="return bloqueiarLetrasContato(event)"
                                   onkeydown="return bloqueiarLetrasContato(event)" 
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 11)"
                                   onpaste="setTimeout(function(){ var el = document.getElementById('id_contato_pf'); el.value = el.value.replace(/[^0-9]/g, '').substring(0, 11); }, 10)"
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">E-mail</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                            <input type="email" name="email_pf" id="id_email_pf" class="form-control" placeholder="email@exemplo.com"
                                   style="text-transform: lowercase;" 
                                   oninput="this.value = this.value.toLowerCase()"
                                   onpaste="setTimeout(function(){ var el = document.getElementById('id_email_pf'); el.value = el.value.toLowerCase(); }, 10)">
                        </div>
                    </div>

                    <div class="d-flex justify-content-end align-items-center">
                        <button type="submit" name="next_action" value="nova_linha" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Salvar e Criar Linha
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- √Årea de sucesso -->
{% if cliente_salvo %}
<div class="mt-3 p-3 bg-success bg-opacity-10 border border-success rounded">
    <h6 class="text-success mb-2">
        <i class="fas fa-check-circle"></i> Cliente Cadastrado com Sucesso!
    </h6>
    <p class="mb-2"><strong>Nome/Empresa:</strong> {{ cliente_salvo.empresa|default:cliente_salvo.nome_completo }}</p>
    <p class="mb-2"><strong>CPF/CNPJ:</strong> {{ cliente_salvo.cnpj|default:cliente_salvo.cpf }}</p>
    <p class="mb-0"><strong>ID:</strong> #{{ cliente_salvo.id }}</p>
    <div class="mt-2">
        <a href="{% url 'linhas:novalinha' %}?empresa={{ cliente_salvo.empresa|default:cliente_salvo.nome_completo }}&cnpj={{ cliente_salvo.cnpj|default:cliente_salvo.cpf }}" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-plus"></i> Criar Linha para este Cliente
        </a>
    </div>
</div>
{% endif %}

{% endblock %}

<!-- Cleave.js (masks) -->
<script src="https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"></script>

<!-- Script para alternar entre tipos de cliente -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== SISTEMA DE ALTERN√ÇNCIA INICIADO ===');
    
    // Elementos
    var btnPJ = document.getElementById('tab-pessoa-juridica');
    var btnPF = document.getElementById('tab-pessoa-fisica');
    var camposPJ = document.getElementById('campos-pj');
    var camposPF = document.getElementById('campos-pf');
    var inputTipo = document.getElementById('input-tipo-pessoa');
    
    console.log('Elementos encontrados:', {
        btnPJ: !!btnPJ,
        btnPF: !!btnPF,
        camposPJ: !!camposPJ,
        camposPF: !!camposPF,
        inputTipo: !!inputTipo
    });
    
    // Fun√ß√£o para alternar tipo
    function alternarTipo(tipo) {
        console.log('=== ALTERNANDO PARA:', tipo, '===');
        
        if (tipo === 'juridica') {
            // Mostrar campos PJ
            if (camposPJ) {
                camposPJ.style.display = 'block';
                console.log('Campos PJ mostrados');
            }
            if (camposPF) {
                camposPF.style.display = 'none';
                console.log('Campos PF ocultados');
            }
            if (inputTipo) {
                inputTipo.value = 'juridica';
                console.log('Tipo definido como juridica');
            }
            
            // Atualizar bot√µes
            if (btnPJ) {
                btnPJ.className = 'btn btn-primary';
                console.log('Bot√£o PJ ativado');
            }
            if (btnPF) {
                btnPF.className = 'btn btn-outline-primary';
                console.log('Bot√£o PF desativado');
            }
            
        } else if (tipo === 'fisica') {
            // Mostrar campos PF
            if (camposPF) {
                camposPF.style.display = 'block';
                console.log('Campos PF mostrados');
            }
            if (camposPJ) {
                camposPJ.style.display = 'none';
                console.log('Campos PJ ocultados');
            }
            if (inputTipo) {
                inputTipo.value = 'fisica';
                console.log('Tipo definido como fisica');
            }
            
            // Atualizar bot√µes
            if (btnPF) {
                btnPF.className = 'btn btn-primary';
                console.log('Bot√£o PF ativado');
            }
            if (btnPJ) {
                btnPJ.className = 'btn btn-outline-primary';
                console.log('Bot√£o PJ desativado');
            }
        }
        
        console.log('=== ALTERN√ÇNCIA CONCLU√çDA ===');
    }
    
    // Event listeners
    if (btnPJ) {
        btnPJ.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('üîò CLIQUE EM PESSOA JUR√çDICA');
            alternarTipo('juridica');
        });
        console.log('Listener PJ adicionado');
    }
    
    if (btnPF) {
        btnPF.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('üîò CLIQUE EM PESSOA F√çSICA');
            alternarTipo('fisica');
        });
        console.log('Listener PF adicionado');
    }
    
    // Inicializar com Pessoa Jur√≠dica
    console.log('Inicializando com Pessoa Jur√≠dica...');
    alternarTipo('juridica');
    
    console.log('=== SISTEMA CONFIGURADO COM SUCESSO ===');
    
    // CPF PF agora usa m√°scara fixa do Cleave.js
    console.log('Sistema de formata√ß√£o CPF com m√°scara fixa ativo');
    
    // Teste ap√≥s 2 segundos para garantir funcionamento
    setTimeout(function() {
        console.log('=== TESTE DE VERIFICA√á√ÉO ===');
        console.log('campos-pj vis√≠vel:', camposPJ ? (camposPJ.style.display !== 'none') : false);
        console.log('campos-pf vis√≠vel:', camposPF ? (camposPF.style.display === 'block') : false);
        
        // Adicionar onclick como backup
        if (btnPJ) {
            btnPJ.onclick = function() {
                console.log('BACKUP: Clique PJ via onclick');
                alternarTipo('juridica');
            };
        }
        if (btnPF) {
            btnPF.onclick = function() {
                console.log('BACKUP: Clique PF via onclick');
                alternarTipo('fisica');
            };
        }
        console.log('Backups onclick adicionados');
    }, 2000);
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize masks for Pessoa Jur√≠dica
    function findCnpjElement() {
        return document.getElementById('id_cnpj') || document.querySelector('input[name="cnpj"]') || document.querySelector('input[id$="cnpj"]');
    }
    function findCpfElement() {
        return document.getElementById('id_cpf_dono') || document.querySelector('input[name="cpf_dono"]') || document.querySelector('input[id$="cpf_dono"]');
    }
    function findDateElement() {
        return document.getElementById('id_data_nascimento_dono') || document.querySelector('input[name="data_nascimento_dono"]') || document.querySelector('input[id$="data_nascimento_dono"]');
    }

    // Initialize masks for Pessoa F√≠sica
    function findCpfPFElement() {
        return document.getElementById('id_cpf_pf') || 
               document.querySelector('input[name="cpf_pf"]') || 
               document.querySelector('input[placeholder*="000.000.000-00"]');
    }
    function findTelefonePFElement() {
        return document.getElementById('id_contato_pf') || 
               document.querySelector('input[name="contato_pf"]') || 
               document.querySelector('input[placeholder*="99999-9999"]');
    }

    try {
        // M√°scaras Pessoa Jur√≠dica
        var cnpjEl = findCnpjElement();
        var cpfEl = findCpfElement();
        var dataEl = findDateElement();

        if (cnpjEl) {
            var cnpjMask = new Cleave(cnpjEl, { delimiters: ['.','.','/','-'], blocks: [2,3,3,4,2], numericOnly: true });
            cnpjEl.addEventListener('paste', function() { setTimeout(function(){ try{ cnpjMask.destroy(); cnpjMask = new Cleave(cnpjEl, { delimiters: ['.','.','/','-'], blocks: [2,3,3,4,2], numericOnly: true }); }catch(e){} }, 50); });
            cnpjEl.addEventListener('focus', function(){ try{ if(!cnpjEl._cleave){ cnpjMask = new Cleave(cnpjEl, { delimiters: ['.','.','/','-'], blocks: [2,3,3,4,2], numericOnly: true }); } }catch(e){} });
        }

        if (cpfEl) {
            var cpfMask = new Cleave(cpfEl, { delimiters: ['.','.','-'], blocks: [3,3,3,2], numericOnly: true });
            cpfEl.addEventListener('paste', function() { setTimeout(function(){ try{ cpfMask.destroy(); cpfMask = new Cleave(cpfEl, { delimiters: ['.','.','-'], blocks: [3,3,3,2], numericOnly: true }); }catch(e){} }, 50); });
        }

        if (dataEl) {
            var dataMask = new Cleave(dataEl, { date: true, datePattern: ['d', 'm', 'Y'] });
        }

        // M√°scaras Pessoa F√≠sica
        var cpfPFEl = findCpfPFElement();
        var telefonePFEl = findTelefonePFElement();

        // CPF PF com valida√ß√£o completa
        if (cpfPFEl) {
            console.log('Aplicando m√°scara CPF PF com valida√ß√£o');
            
            // Fun√ß√£o para validar CPF
            function validarCPF(cpf) {
                cpf = cpf.replace(/[^\d]+/g, '');
                if (cpf.length !== 11) return false;
                
                // Elimina CPFs conhecidos que s√£o inv√°lidos
                if (/^(.)\1+$/.test(cpf)) return false;
                
                // Valida 1¬∫ d√≠gito verificador
                var soma = 0;
                for (var i = 0; i < 9; i++) {
                    soma += parseInt(cpf.charAt(i)) * (10 - i);
                }
                var resto = 11 - (soma % 11);
                var dv1 = (resto < 2) ? 0 : resto;
                
                if (dv1 !== parseInt(cpf.charAt(9))) return false;
                
                // Valida 2¬∫ d√≠gito verificador
                soma = 0;
                for (var i = 0; i < 10; i++) {
                    soma += parseInt(cpf.charAt(i)) * (11 - i);
                }
                resto = 11 - (soma % 11);
                var dv2 = (resto < 2) ? 0 : resto;
                
                return dv2 === parseInt(cpf.charAt(10));
            }
            
            // Aplicar apenas valida√ß√£o num√©rica (sem formata√ß√£o)
            console.log('Campo CPF configurado apenas para n√∫meros');
            
            // Criar div para mensagem de valida√ß√£o
            var msgDiv = document.createElement('div');
            msgDiv.id = 'cpf-validation-msg';
            msgDiv.className = 'form-text mt-1';
            msgDiv.style.display = 'none';
            cpfPFEl.parentNode.parentNode.appendChild(msgDiv);
            
            // Evento para validar quando sair do campo
            cpfPFEl.addEventListener('blur', function() {
                var cpfValue = this.value;
                var msgDiv = document.getElementById('cpf-validation-msg');
                
                if (cpfValue.length === 11) { // CPF completo (apenas n√∫meros)
                    if (validarCPF(cpfValue)) {
                        msgDiv.textContent = '‚úÖ CPF v√°lido';
                        msgDiv.className = 'form-text mt-1 text-success';
                        msgDiv.style.display = 'block';
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    } else {
                        msgDiv.textContent = '‚ùå CPF inv√°lido';
                        msgDiv.className = 'form-text mt-1 text-danger';
                        msgDiv.style.display = 'block';
                        this.classList.remove('is-valid');
                        this.classList.add('is-invalid');
                    }
                } else if (cpfValue.length > 0) {
                    msgDiv.textContent = '‚ö†Ô∏è CPF incompleto (' + cpfValue.length + '/11 d√≠gitos)';
                    msgDiv.className = 'form-text mt-1 text-warning';
                    msgDiv.style.display = 'block';
                    this.classList.remove('is-valid', 'is-invalid');
                } else {
                    msgDiv.style.display = 'none';
                    this.classList.remove('is-valid', 'is-invalid');
                }
            });
            
            // Evento adicional para bloquear teclas n√£o num√©ricas
            cpfPFEl.addEventListener('keydown', function(e) {
                // Permitir: backspace, delete, tab, escape, enter
                if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                    // Permitir: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true) ||
                    // Permitir: home, end, setas
                    (e.keyCode >= 35 && e.keyCode <= 39)) {
                    return;
                }
                // Permitir apenas n√∫meros (0-9)
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });
            
            console.log('‚úÖ M√°scara CPF PF com valida√ß√£o aplicada');
        } else {
            console.warn('‚ùå Campo CPF PF n√£o encontrado');
        }

        if (telefonePFEl) {
            console.log('Aplicando m√°scara telefone em:', telefonePFEl);
            var telefonePFMask = new Cleave(telefonePFEl, { phone: true, phoneRegionCode: 'BR' });
            console.log('‚úÖ M√°scara telefone aplicada com sucesso');
        } else {
            console.warn('‚ùå Campo telefone PF n√£o encontrado para aplicar m√°scara');
        }

    } catch (e) {
        console.warn('Cleave init failed', e);
    }
    
    // Tentar novamente ap√≥s 2 segundos para elementos em abas ocultas
    setTimeout(function() {
        console.log('=== SEGUNDA TENTATIVA M√ÅSCARAS ===');
        
        // CPF PF - segunda tentativa com valida√ß√£o completa
        var cpfPFEl = findCpfPFElement();
        if (cpfPFEl && !cpfPFEl._cleave && !cpfPFEl.hasAttribute('data-cpf-configured')) {
            console.log('Aplicando m√°scara CPF PF com valida√ß√£o (segunda tentativa)');
            try {
                // Fun√ß√£o para validar CPF
                function validarCPF(cpf) {
                    cpf = cpf.replace(/[^\d]+/g, '');
                    if (cpf.length !== 11) return false;
                    
                    // Elimina CPFs conhecidos que s√£o inv√°lidos
                    if (/^(.)\1+$/.test(cpf)) return false;
                    
                    // Valida 1¬∫ d√≠gito verificador
                    var soma = 0;
                    for (var i = 0; i < 9; i++) {
                        soma += parseInt(cpf.charAt(i)) * (10 - i);
                    }
                    var resto = 11 - (soma % 11);
                    var dv1 = (resto < 2) ? 0 : resto;
                    
                    if (dv1 !== parseInt(cpf.charAt(9))) return false;
                    
                    // Valida 2¬∫ d√≠gito verificador
                    soma = 0;
                    for (var i = 0; i < 10; i++) {
                        soma += parseInt(cpf.charAt(i)) * (11 - i);
                    }
                    resto = 11 - (soma % 11);
                    var dv2 = (resto < 2) ? 0 : resto;
                    
                    return dv2 === parseInt(cpf.charAt(10));
                }
                
                // Configurar campo apenas para n√∫meros (sem formata√ß√£o)
                console.log('Campo CPF configurado para n√∫meros apenas (segunda tentativa)');
                
                // Criar div para mensagem de valida√ß√£o se n√£o existir
                var msgDiv = document.getElementById('cpf-validation-msg');
                if (!msgDiv) {
                    msgDiv = document.createElement('div');
                    msgDiv.id = 'cpf-validation-msg';
                    msgDiv.className = 'form-text mt-1';
                    msgDiv.style.display = 'none';
                    cpfPFEl.parentNode.parentNode.appendChild(msgDiv);
                }
                
                // Evento para validar quando sair do campo
                cpfPFEl.addEventListener('blur', function() {
                    var cpfValue = this.value;
                    var msgDiv = document.getElementById('cpf-validation-msg');
                    
                    if (cpfValue.length === 11) { // CPF completo (apenas n√∫meros)
                        if (validarCPF(cpfValue)) {
                            msgDiv.textContent = '‚úÖ CPF v√°lido';
                            msgDiv.className = 'form-text mt-1 text-success';
                            msgDiv.style.display = 'block';
                            this.classList.remove('is-invalid');
                            this.classList.add('is-valid');
                        } else {
                            msgDiv.textContent = '‚ùå CPF inv√°lido';
                            msgDiv.className = 'form-text mt-1 text-danger';
                            msgDiv.style.display = 'block';
                            this.classList.remove('is-valid');
                            this.classList.add('is-invalid');
                        }
                    } else if (cpfValue.length > 0) {
                        msgDiv.textContent = '‚ö†Ô∏è CPF incompleto (' + cpfValue.length + '/11 d√≠gitos)';
                        msgDiv.className = 'form-text mt-1 text-warning';
                        msgDiv.style.display = 'block';
                        this.classList.remove('is-valid', 'is-invalid');
                    } else {
                        msgDiv.style.display = 'none';
                        this.classList.remove('is-valid', 'is-invalid');
                    }
                });
                
                // Evento adicional para bloquear teclas n√£o num√©ricas
                cpfPFEl.addEventListener('keydown', function(e) {
                    // Permitir: backspace, delete, tab, escape, enter
                    if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                        // Permitir: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                        (e.keyCode === 65 && e.ctrlKey === true) ||
                        (e.keyCode === 67 && e.ctrlKey === true) ||
                        (e.keyCode === 86 && e.ctrlKey === true) ||
                        (e.keyCode === 88 && e.ctrlKey === true) ||
                        // Permitir: home, end, setas
                        (e.keyCode >= 35 && e.keyCode <= 39)) {
                        return;
                    }
                    // Permitir apenas n√∫meros (0-9)
                    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                        e.preventDefault();
                    }
                });
                
                cpfPFEl.setAttribute('data-cpf-configured', 'true');
                console.log('‚úÖ M√°scara CPF PF com valida√ß√£o aplicada na segunda tentativa');
            } catch (e) {
                console.warn('Erro na segunda tentativa CPF PF:', e);
            }
        }
        
        var telefonePFEl = findTelefonePFElement();
        if (telefonePFEl && !telefonePFEl._cleave) {
            console.log('Aplicando m√°scara telefone (segunda tentativa)');
            try {
                var telefonePFMask = new Cleave(telefonePFEl, { phone: true, phoneRegionCode: 'BR' });
                console.log('‚úÖ M√°scara telefone aplicada na segunda tentativa');
            } catch (e) {
                console.warn('Erro na segunda tentativa telefone:', e);
            }
        }
    }, 2000);
});
</script>

<script>
// Fetch CNPJ data on demand (button) with fallback and inline alerts
document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log('novo_cliente: CNPJ script init');
    } catch (e) {}

    // robustly locate the CNPJ input and the Buscar button using fallbacks
    var cnpjInput = document.getElementById('id_cnpj') || document.querySelector('input[name="cnpj"]') || document.querySelector('input[id$="cnpj"]');
    if (!cnpjInput) {
        console.warn('CNPJ input not found on page');
        return;
    }

    // Apply the same live-formatting used in relatorios: format as 00.000.000/0000-00 while typing/pasting
    function onlyDigits(v){ return (v || '').replace(/\D/g, ''); }
    function formatCNPJ(v){
        v = onlyDigits(v).slice(0,14);
        if (v.length <= 2) return v;
        if (v.length <= 5) return v.slice(0,2) + '.' + v.slice(2);
        if (v.length <= 8) return v.slice(0,2) + '.' + v.slice(2,5) + '.' + v.slice(5);
        if (v.length <= 12) return v.slice(0,2) + '.' + v.slice(2,5) + '.' + v.slice(5,8) + '/' + v.slice(8);
        return v.slice(0,2) + '.' + v.slice(2,5) + '.' + v.slice(5,8) + '/' + v.slice(8,12) + '-' + v.slice(12);
    }
    try {
        cnpjInput.addEventListener('input', function(e){
            try{
                var pos = this.selectionStart || 0;
                var old = this.value || '';
                this.value = formatCNPJ(this.value);
                // try to preserve cursor roughly
                if (this.value.length > old.length) {
                    this.selectionStart = this.selectionEnd = pos + (this.value.length - old.length);
                }
            }catch(err){/* ignore */}
        });
    } catch (e) { console.warn('attach cnpj formatter failed', e); }

    var btnBuscar = document.getElementById('btn-buscar-cnpj') || document.querySelector('button[title*="Buscar"]');
    // ensure button is enabled on load
    try { if (btnBuscar) { btnBuscar.disabled = false; btnBuscar.style.cursor = 'pointer'; } } catch (e) { console.warn(e); }
    var razaoEl = document.getElementById('id_razao_social');
    var fantasiaEl = document.getElementById('id_fantasia');
    var enderecoEl = document.getElementById('id_endereco_completo');
    var alertEl = document.getElementById('cnpj-alert');

    function showAlert(msg, isError) {
        try {
            if (!alertEl) return;
            alertEl.style.display = msg ? '' : 'none';
            alertEl.textContent = msg || '';
            alertEl.classList.toggle('text-danger', !!isError);
            alertEl.classList.toggle('text-success', !isError && !!msg);
        } catch (err) {
            try { console.warn('showAlert error', err); } catch (e) {}
        }
    }

    async function buscarCnpj() {
        showAlert('', false);
        var digits = (cnpjInput.value || '').replace(/\D/g, '');
        if (digits.length !== 14) {
            showAlert('Digite o CNPJ completo (14 d√≠gitos).', true);
            return;
        }

        btnBuscar && (btnBuscar.disabled = true);
        showAlert('Buscando dados do CNPJ...', false);

        try {
            // Usar nossa API interna que j√° tem fallback BrasilAPI + ReceitaWS
            var url = '/linhas/buscar-cnpj-api/?cnpj=' + digits;
            console.log('Fazendo requisi√ß√£o para:', url);
            
            var response = await fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                }
            });
            
            console.log('Status da resposta:', response.status);
            
            if (!response.ok) {
                throw new Error('Erro na requisi√ß√£o: ' + response.status);
            }
            
            var result = await response.json();
            console.log('Resultado da API:', result);
            
            if (!result.success) {
                throw new Error(result.error || 'CNPJ n√£o encontrado');
            }
            
            var data = result.dados;

            // Preencher os campos com os dados recebidos
            if (data) {
                var razao = data.razao_social || data.nome || '';
                var fantasia = data.fantasia || data.nome_fantasia || '';
                var endereco = '';
                
                // Construir endere√ßo completo
                var endParts = [];
                if (data.endereco) endParts.push(data.endereco);
                if (data.numero) endParts.push(data.numero);
                if (data.complemento) endParts.push(data.complemento);
                if (data.bairro) endParts.push(data.bairro);
                if (data.municipio) endParts.push(data.municipio);
                if (data.uf) endParts.push(data.uf);
                if (data.cep) endParts.push('CEP: ' + data.cep);
                endereco = endParts.join(', ');

                // Preencher os campos do formul√°rio
                if (razaoEl && razao) razaoEl.value = razao;
                if (fantasiaEl && fantasia) fantasiaEl.value = fantasia;
                if (enderecoEl && endereco) enderecoEl.value = endereco;
                
                showAlert('Dados do CNPJ carregados com sucesso! Fonte: ' + (data.fonte || 'API Externa'), false);
            } else {
                throw new Error('Dados n√£o encontrados');
            }
        } catch (error) {
            console.error('Erro ao buscar CNPJ:', error);
            showAlert('Erro: ' + error.message, true);
        }
    }

    // Event listeners para o bot√£o
    if (btnBuscar) {
        btnBuscar.addEventListener('click', function(ev) {
            try {
                ev.preventDefault();
                btnBuscar.disabled = true;
                btnBuscar.dataset.origHtml = btnBuscar.innerHTML;
                btnBuscar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
            } catch (e) { console.warn(e); }
            buscarCnpj().finally(function() {
                try { btnBuscar.disabled = false; btnBuscar.innerHTML = btnBuscar.dataset.origHtml || '<i class="fas fa-search"></i> Buscar CNPJ'; } catch (xx) {}
            });
        });
    } else {
        console.warn('Buscar CNPJ button not found to attach listener');
    }

    // Fallback delegated listener on document body in case direct binding fails
    document.body.addEventListener('click', function(e) {
        try {
            var el = e.target.closest ? e.target.closest('#btn-buscar-cnpj') : null;
            if (el) {
                e.preventDefault();
                try { el.disabled = true; el.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...'; } catch (xx) {}
                buscarCnpj().finally(function() {
                    try { el.disabled = false; el.innerHTML = '<i class="fas fa-search"></i> Buscar CNPJ'; } catch (xx) {}
                });
            }
        } catch (err) { try { console.warn(err); } catch (e) {} }
    });
});
</script>

<!-- Script simplificado adicional para debug -->
<script>
console.log('Script adicional carregado para debug do bot√£o CNPJ');

// Aguarda carregamento completo
window.addEventListener('load', function() {
    console.log('P√°gina totalmente carregada');
    
    // Tenta novamente encontrar o bot√£o ap√≥s carregamento completo
    setTimeout(function() {
        var btnBuscar = document.getElementById('btn-buscar-cnpj');
        var cnpjInput = document.getElementById('id_cnpj');
        
        console.log('Debug - Bot√£o encontrado:', !!btnBuscar);
        console.log('Debug - Input CNPJ encontrado:', !!cnpjInput);
        
        if (btnBuscar && !btnBuscar.hasAttribute('data-listener-added')) {
            console.log('Adicionando listener adicional ao bot√£o');
            btnBuscar.setAttribute('data-listener-added', 'true');
            
            btnBuscar.addEventListener('click', async function(e) {
                e.preventDefault();
                console.log('Listener adicional executado');
                
                if (!cnpjInput) {
                    console.error('Input CNPJ n√£o encontrado no listener adicional');
                    alert('Erro: Input CNPJ n√£o encontrado');
                    return;
                }
                
                var cnpj = cnpjInput.value.replace(/\D/g, '');
                console.log('CNPJ extra√≠do:', cnpj);
                
                if (cnpj.length !== 14) {
                    alert('Digite um CNPJ com 14 d√≠gitos');
                    return;
                }
                
                btnBuscar.disabled = true;
                btnBuscar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
                
                try {
                    var url = '/linhas/buscar-cnpj-api/?cnpj=' + cnpj;
                    console.log('Fazendo requisi√ß√£o para:', url);
                    
                    var response = await fetch(url);
                    console.log('Status da resposta:', response.status);
                    
                    var result = await response.json();
                    console.log('Resultado da API:', result);
                    
                    if (result.success) {
                        var data = result.dados;
                        
                        // Preencher campos
                        var razaoEl = document.getElementById('id_razao_social');
                        var fantasiaEl = document.getElementById('id_fantasia');
                        var enderecoEl = document.getElementById('id_endereco_completo');
                        
                        if (razaoEl && data.razao_social) {
                            razaoEl.value = data.razao_social;
                        }
                        
                        if (fantasiaEl && data.fantasia) {
                            fantasiaEl.value = data.fantasia;
                        }
                        
                        if (enderecoEl) {
                            var endParts = [];
                            if (data.endereco) endParts.push(data.endereco);
                            if (data.numero) endParts.push(data.numero);
                            if (data.complemento) endParts.push(data.complemento);
                            if (data.bairro) endParts.push(data.bairro);
                            if (data.municipio) endParts.push(data.municipio);
                            if (data.uf) endParts.push(data.uf);
                            if (data.cep) endParts.push('CEP: ' + data.cep);
                            enderecoEl.value = endParts.join(', ');
                        }
                        
                        alert('Dados carregados com sucesso! Fonte: ' + (data.fonte || 'API'));
                        
                    } else {
                        alert('Erro: ' + (result.error || 'CNPJ n√£o encontrado'));
                    }
                    
                } catch (error) {
                    console.error('Erro na requisi√ß√£o:', error);
                    alert('Erro: ' + error.message);
                } finally {
                    btnBuscar.disabled = false;
                    btnBuscar.innerHTML = '<i class="fas fa-search"></i> Buscar CNPJ';
                }
            });
        }
    }, 1000); // Aguarda 1 segundo ap√≥s carregamento completo
});
</script>

<!-- Script para convers√£o autom√°tica para mai√∫sculas -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Configurando convers√£o autom√°tica para mai√∫sculas');
    
    // Fun√ß√£o para aplicar mai√∫sculas
    function aplicarMaiusculas(elemento) {
        if (!elemento) return;
        
        // Converter valor atual
        elemento.value = elemento.value.toUpperCase();
        
        // Eventos para convers√£o autom√°tica
        elemento.addEventListener('input', function() {
            var cursorPos = this.selectionStart;
            this.value = this.value.toUpperCase();
            this.setSelectionRange(cursorPos, cursorPos);
        });
        
        elemento.addEventListener('paste', function() {
            var self = this;
            setTimeout(function() {
                var cursorPos = self.selectionStart;
                self.value = self.value.toUpperCase();
                self.setSelectionRange(cursorPos, cursorPos);
            }, 10);
        });
        
        elemento.addEventListener('blur', function() {
            this.value = this.value.toUpperCase();
        });
    }
    
    // Fun√ß√£o para aplicar min√∫sculas
    function aplicarMinusculas(elemento) {
        if (!elemento) return;
        
        // Converter valor atual
        elemento.value = elemento.value.toLowerCase();
        
        // Eventos para convers√£o autom√°tica
        elemento.addEventListener('input', function() {
            var cursorPos = this.selectionStart;
            this.value = this.value.toLowerCase();
            this.setSelectionRange(cursorPos, cursorPos);
        });
        
        elemento.addEventListener('paste', function() {
            var self = this;
            setTimeout(function() {
                var cursorPos = self.selectionStart;
                self.value = self.value.toLowerCase();
                self.setSelectionRange(cursorPos, cursorPos);
            }, 10);
        });
        
        elemento.addEventListener('blur', function() {
            this.value = this.value.toLowerCase();
        });
    }
    
    // Aplicar nos campos da Pessoa F√≠sica
    var nomeCompleto = document.getElementById('id_nome_completo');
    var enderecoPF = document.getElementById('id_endereco_pf');
    var emailPF = document.getElementById('id_email_pf');
    
    if (nomeCompleto) {
        aplicarMaiusculas(nomeCompleto);
        console.log('‚úÖ Convers√£o mai√∫sculas aplicada no Nome Completo PF');
    }
    
    if (enderecoPF) {
        aplicarMaiusculas(enderecoPF);
        console.log('‚úÖ Convers√£o mai√∫sculas aplicada no Endere√ßo PF');
    }
    
    if (emailPF) {
        aplicarMinusculas(emailPF);
        console.log('‚úÖ Convers√£o min√∫sculas aplicada no Email PF');
    }
    
    // Tentar novamente ap√≥s 2 segundos (para abas ocultas)
    setTimeout(function() {
        var nomeCompleto = document.getElementById('id_nome_completo');
        var enderecoPF = document.getElementById('id_endereco_pf');
        var emailPF = document.getElementById('id_email_pf');
        
        if (nomeCompleto && !nomeCompleto.hasAttribute('data-uppercase-configured')) {
            aplicarMaiusculas(nomeCompleto);
            nomeCompleto.setAttribute('data-uppercase-configured', 'true');
            console.log('‚úÖ Convers√£o mai√∫sculas aplicada no Nome Completo PF (segunda tentativa)');
        }
        
        if (enderecoPF && !enderecoPF.hasAttribute('data-uppercase-configured')) {
            aplicarMaiusculas(enderecoPF);
            enderecoPF.setAttribute('data-uppercase-configured', 'true');
            console.log('‚úÖ Convers√£o mai√∫sculas aplicada no Endere√ßo PF (segunda tentativa)');
        }
        
        if (emailPF && !emailPF.hasAttribute('data-lowercase-configured')) {
            aplicarMinusculas(emailPF);
            emailPF.setAttribute('data-lowercase-configured', 'true');
            console.log('‚úÖ Convers√£o min√∫sculas aplicada no Email PF (segunda tentativa)');
        }
    }, 2000);
});
</script>

<!-- Script adicional para prote√ß√£o rigorosa do campo CPF -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Configurando prote√ß√£o rigorosa do CPF');
    
    function protegerCampoCPF() {
        var cpfField = document.getElementById('id_cpf_pf');
        if (!cpfField) return;
        
        // Fun√ß√£o para limpar caracteres inv√°lidos e limitar a 11 n√∫meros
        function limparCPF(valor) {
            // Remove tudo que n√£o √© n√∫mero
            var somenteNumeros = valor.replace(/[^0-9]/g, '');
            
            // Limita a 11 d√≠gitos
            somenteNumeros = somenteNumeros.substring(0, 11);
            
            console.log('CPF antes:', valor, 'N√∫meros:', somenteNumeros.length, 'CPF limpo:', somenteNumeros);
            return somenteNumeros;
        }
        
        // Evento input - limpa em tempo real
        cpfField.addEventListener('input', function(e) {
            var cursorPos = this.selectionStart;
            var valorAnterior = this.value;
            var valorLimpo = limparCPF(this.value);
            
            if (valorAnterior !== valorLimpo) {
                this.value = valorLimpo;
                console.log('CPF limpo via input:', valorLimpo);
                
                // Tentar manter posi√ß√£o do cursor
                try {
                    this.setSelectionRange(cursorPos, cursorPos);
                } catch (e) {}
            }
        });
        
        // Evento paste - limpa texto colado
        cpfField.addEventListener('paste', function(e) {
            var self = this;
            setTimeout(function() {
                var valorLimpo = limparCPF(self.value);
                if (self.value !== valorLimpo) {
                    self.value = valorLimpo;
                    console.log('CPF limpo via paste:', valorLimpo);
                }
            }, 10);
        });
        
        // Evento keypress - bloqueia teclas inv√°lidas e limita a 11 n√∫meros
        cpfField.addEventListener('keypress', function(e) {
            var char = String.fromCharCode(e.which);
            var keyCode = e.which || e.keyCode;
            
            // Contar quantos n√∫meros j√° existem
            var somenteNumeros = this.value.replace(/[^0-9]/g, '');
            
            console.log('üîç Tecla pressionada:', char, 'C√≥digo:', keyCode, 'N√∫meros atuais:', somenteNumeros.length);
            
            // Teclas especiais permitidas
            var teclasEspeciais = [8, 9, 13, 27, 35, 36, 37, 38, 39, 40, 46];
            if (teclasEspeciais.indexOf(keyCode) !== -1) {
                console.log('‚úÖ Tecla especial permitida:', keyCode);
                return true;
            }
            
            // Ctrl + teclas
            if (e.ctrlKey) {
                console.log('‚úÖ Ctrl + tecla permitida');
                return true;
            }
            
            // Se for um n√∫mero e j√° tiver 11 d√≠gitos, bloquear
            if (/[0-9]/.test(char) && somenteNumeros.length >= 11) {
                console.log('üö´ CPF j√° tem 11 n√∫meros, bloqueando:', char);
                e.preventDefault();
                return false;
            }
            
            // Permitir apenas n√∫meros
            if (!/[0-9]/.test(char)) {
                console.log('üö´ N√£o √© n√∫mero, bloqueando:', char, 'C√≥digo:', keyCode);
                e.preventDefault();
                return false;
            }
            
            console.log('‚úÖ N√∫mero permitido:', char);
        });
        
        // Evento blur - limpeza final
        cpfField.addEventListener('blur', function() {
            var valorLimpo = limparCPF(this.value);
            if (this.value !== valorLimpo) {
                this.value = valorLimpo;
                console.log('CPF limpo via blur:', valorLimpo);
            }
        });
        
        console.log('‚úÖ Prote√ß√£o rigorosa aplicada no campo CPF');
    }
    
    function protegerCampoContato() {
        var contatoField = document.getElementById('id_contato_pf');
        if (!contatoField) return;
        
        // Fun√ß√£o para limpar caracteres inv√°lidos e limitar a 11 n√∫meros
        function limparContato(valor) {
            // Remove tudo que n√£o √© n√∫mero
            var somenteNumeros = valor.replace(/[^0-9]/g, '');
            
            // Limita a 11 d√≠gitos
            somenteNumeros = somenteNumeros.substring(0, 11);
            
            console.log('Contato antes:', valor, 'N√∫meros:', somenteNumeros.length, 'Contato limpo:', somenteNumeros);
            return somenteNumeros;
        }
        
        // Evento input - limpa em tempo real
        contatoField.addEventListener('input', function(e) {
            var cursorPos = this.selectionStart;
            var valorAnterior = this.value;
            var valorLimpo = limparContato(this.value);
            
            if (valorAnterior !== valorLimpo) {
                this.value = valorLimpo;
                console.log('Contato limpo via input:', valorLimpo);
                
                // Tentar manter posi√ß√£o do cursor
                try {
                    this.setSelectionRange(cursorPos, cursorPos);
                } catch (e) {}
            }
        });
        
        // Evento paste - limpa texto colado
        contatoField.addEventListener('paste', function(e) {
            var self = this;
            setTimeout(function() {
                var valorLimpo = limparContato(self.value);
                if (self.value !== valorLimpo) {
                    self.value = valorLimpo;
                    console.log('Contato limpo via paste:', valorLimpo);
                }
            }, 10);
        });
        
        // Evento keypress - bloqueia teclas inv√°lidas
        contatoField.addEventListener('keypress', function(e) {
            var char = String.fromCharCode(e.which);
            
            // Contar quantos n√∫meros j√° existem
            var somenteNumeros = this.value.replace(/[^0-9]/g, '');
            
            // Se for um n√∫mero e j√° tiver 11 d√≠gitos, bloquear
            if (/[0-9]/.test(char) && somenteNumeros.length >= 11) {
                console.log('Contato j√° tem 11 n√∫meros, bloqueando:', char);
                e.preventDefault();
                return false;
            }
            
            // Permitir apenas n√∫meros
            if (!/[0-9]/.test(char) && !e.ctrlKey) {
                console.log('Tecla bloqueada:', char);
                e.preventDefault();
                return false;
            }
        });
        
        // Evento blur - limpeza final
        contatoField.addEventListener('blur', function() {
            var valorLimpo = limparContato(this.value);
            if (this.value !== valorLimpo) {
                this.value = valorLimpo;
                console.log('Contato limpo via blur:', valorLimpo);
            }
        });
        
        console.log('‚úÖ Prote√ß√£o rigorosa aplicada no campo Contato');
    }
    
    // Aplicar prote√ß√£o imediatamente
    protegerCampoCPF();
    protegerCampoContato();
    
    // Tentar novamente ap√≥s 2 segundos
    setTimeout(function() {
        protegerCampoCPF();
        protegerCampoContato();
        console.log('‚úÖ Prote√ß√£o CPF e Contato aplicada (segunda tentativa)');
    }, 2000);
});
</script>

<!-- Script super rigoroso para bloquear letras no contato -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Aplicando prote√ß√£o super rigorosa no contato');
    
    function protecaoRigorosaContato() {
        var contato = document.getElementById('id_contato_pf');
        if (!contato) {
            console.log('Campo contato n√£o encontrado');
            return;
        }
        
        console.log('Campo contato encontrado, aplicando prote√ß√£o');
        
        // Fun√ß√£o para limpar o valor
        function limpar(valor) {
            var limpo = valor.replace(/[^0-9]/g, '').substring(0, 11);
            console.log('Limpeza:', valor, '->', limpo);
            return limpo;
        }
        
        // Interceptar TODAS as tentativas de entrada
        contato.addEventListener('input', function(e) {
            console.log('INPUT detectado:', this.value);
            var limpo = limpar(this.value);
            if (this.value !== limpo) {
                this.value = limpo;
                console.log('Valor corrigido para:', limpo);
            }
        }, true);
        
        contato.addEventListener('keydown', function(e) {
            var char = e.key;
            console.log('KEYDOWN:', e.keyCode, char);
            
            // Permitir teclas especiais
            if (['Backspace', 'Delete', 'Tab', 'Enter', 'Escape', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'].includes(char)) {
                return true;
            }
            
            // Permitir Ctrl+comandos
            if (e.ctrlKey) {
                return true;
            }
            
            // Permitir apenas n√∫meros se n√£o exceder 11
            if (/^[0-9]$/.test(char)) {
                var numeros = this.value.replace(/[^0-9]/g, '');
                if (numeros.length >= 11) {
                    console.log('BLOQUEADO: Limite de 11 n√∫meros atingido');
                    e.preventDefault();
                    return false;
                }
                return true;
            }
            
            // Bloquear tudo o resto
            console.log('BLOQUEADO: Caractere inv√°lido:', char);
            e.preventDefault();
            return false;
        }, true);
        
        contato.addEventListener('paste', function(e) {
            console.log('PASTE detectado');
            setTimeout(() => {
                var limpo = limpar(this.value);
                this.value = limpo;
                console.log('Paste limpo:', limpo);
            }, 1);
        }, true);
        
        // Interceptar digita√ß√£o direta
        contato.addEventListener('beforeinput', function(e) {
            console.log('BEFOREINPUT:', e.inputType, e.data);
            if (e.inputType === 'insertText' && e.data) {
                if (!/^[0-9]$/.test(e.data)) {
                    console.log('BLOQUEADO via beforeinput:', e.data);
                    e.preventDefault();
                    return false;
                }
                
                var numeros = this.value.replace(/[^0-9]/g, '');
                if (numeros.length >= 11) {
                    console.log('BLOQUEADO via beforeinput: Limite atingido');
                    e.preventDefault();
                    return false;
                }
            }
        }, true);
        
        console.log('‚úÖ Prote√ß√£o super rigorosa aplicada no contato');
    }
    
    // Aplicar imediatamente
    protecaoRigorosaContato();
    
    // Tentar novamente ap√≥s delay
    setTimeout(protecaoRigorosaContato, 1000);
    setTimeout(protecaoRigorosaContato, 3000);
    
    // Fun√ß√£o para for√ßar min√∫sculas no email
    function forcaMinusculasEmail() {
        var emailField = document.getElementById('id_email_pf');
        if (!emailField) {
            console.log('Campo email n√£o encontrado');
            return;
        }
        
        console.log('Aplicando convers√£o autom√°tica para min√∫sculas no email');
        
        // Fun√ß√£o para aplicar min√∫sculas
        function aplicarMinusculas(elemento) {
            if (!elemento) return;
            
            // Converter valor atual
            elemento.value = elemento.value.toLowerCase();
            
            // Eventos para convers√£o autom√°tica
            elemento.addEventListener('input', function() {
                var cursorPos = this.selectionStart;
                this.value = this.value.toLowerCase();
                this.setSelectionRange(cursorPos, cursorPos);
            });
            
            elemento.addEventListener('paste', function() {
                var self = this;
                setTimeout(function() {
                    var cursorPos = self.selectionStart;
                    self.value = self.value.toLowerCase();
                    self.setSelectionRange(cursorPos, cursorPos);
                }, 10);
            });
            
            elemento.addEventListener('blur', function() {
                this.value = this.value.toLowerCase();
            });
            
            elemento.addEventListener('keydown', function(e) {
                // Para teclas que inserem texto, converter imediatamente
                setTimeout(() => {
                    if (this.value !== this.value.toLowerCase()) {
                        var cursorPos = this.selectionStart;
                        this.value = this.value.toLowerCase();
                        this.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 1);
            });
        }
        
        aplicarMinusculas(emailField);
        console.log('‚úÖ Convers√£o min√∫sculas aplicada no email');
    }
    
    // Aplicar convers√£o de min√∫sculas
    forcaMinusculasEmail();
    setTimeout(forcaMinusculasEmail, 1000);
    setTimeout(forcaMinusculasEmail, 3000);
});
</script>
