{% extends 'base.html' %}

{% block title %}Novo Cliente - Gestor de Linhas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-user-plus"></i> Novo Cliente</h1>
    <a href="{% url 'linhas:novalinha' %}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Voltar</a>
</div>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}

            <div class="mb-3 position-relative">
                <label class="form-label small">CNPJ</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                    {{ form.cnpj }}
                    <button type="button" class="btn btn-outline-secondary" id="btn-buscar-cnpj" title="Buscar dados por CNPJ">
                        <i class="fas fa-search"></i> Buscar CNPJ
                    </button>
                </div>
                <div id="cnpj-alert" class="form-text text-danger mt-1" style="display:none;"></div>
                {% if form.cnpj.errors %}<div class="text-danger small">{{ form.cnpj.errors.0 }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label class="form-label small">Razão Social</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
                    {{ form.razao_social }}
                </div>
                {% if form.razao_social.errors %}<div class="text-danger small">{{ form.razao_social.errors.0 }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label class="form-label small">Fantasia</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-tag"></i></span>
                    {{ form.fantasia }}
                </div>
                {% if form.fantasia.errors %}<div class="text-danger small">{{ form.fantasia.errors.0 }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label class="form-label small">Endereço</label>
                {{ form.endereco_completo }}
                {% if form.endereco_completo.errors %}<div class="text-danger small">{{ form.endereco_completo.errors.0 }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label class="form-label small">Contato principal</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                    {{ form.contato }}
                </div>
                {% if form.contato.errors %}<div class="text-danger small">{{ form.contato.errors.0 }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label class="form-label small">Email</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                    {{ form.email }}
                </div>
                {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors.0 }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label class="form-label small">Nome proprietário</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-user-tie"></i></span>
                    {{ form.nome_dono }}
                </div>
                {% if form.nome_dono.errors %}<div class="text-danger small">{{ form.nome_dono.errors.0 }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label class="form-label small">CPF</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                    {{ form.cpf_dono }}
                </div>
                {% if form.cpf_dono.errors %}<div class="text-danger small">{{ form.cpf_dono.errors.0 }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label class="form-label small">Data de nascimento</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                    {{ form.data_nascimento_dono }}
                </div>
                {% if form.data_nascimento_dono.errors %}<div class="text-danger small">{{ form.data_nascimento_dono.errors.0 }}</div>{% endif %}
            </div>
            <div class="d-flex justify-content-end">
                <a href="{% url 'linhas:novalinha' %}" class="btn btn-secondary me-2">Cancelar</a>
                <button class="btn btn-primary" type="submit">Salvar Cliente</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

<!-- Cleave.js (masks) -->
<script src="https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize masks with multiple fallbacks to handle different rendering scenarios
    function findCnpjElement() {
        return document.getElementById('id_cnpj') || document.querySelector('input[name="cnpj"]') || document.querySelector('input[id$="cnpj"]');
    }
    function findCpfElement() {
        return document.getElementById('id_cpf_dono') || document.querySelector('input[name="cpf_dono"]') || document.querySelector('input[id$="cpf_dono"]');
    }
    function findDateElement() {
        return document.getElementById('id_data_nascimento_dono') || document.querySelector('input[name="data_nascimento_dono"]') || document.querySelector('input[id$="data_nascimento_dono"]');
    }

    try {
        var cnpjEl = findCnpjElement();
        var cpfEl = findCpfElement();
        var dataEl = findDateElement();

        // Apply mask when element exists. Also re-init on focus/paste to handle programmatic inserts.
        if (cnpjEl) {
            var cnpjMask = new Cleave(cnpjEl, { delimiters: ['.','.','/','-'], blocks: [2,3,3,4,2], numericOnly: true });
            cnpjEl.addEventListener('paste', function() { setTimeout(function(){ try{ cnpjMask.destroy(); cnpjMask = new Cleave(cnpjEl, { delimiters: ['.','.','/','-'], blocks: [2,3,3,4,2], numericOnly: true }); }catch(e){} }, 50); });
            cnpjEl.addEventListener('focus', function(){ try{ if(!cnpjEl._cleave){ cnpjMask = new Cleave(cnpjEl, { delimiters: ['.','.','/','-'], blocks: [2,3,3,4,2], numericOnly: true }); } }catch(e){} });
        }

        if (cpfEl) {
            var cpfMask = new Cleave(cpfEl, { delimiters: ['.','.','-'], blocks: [3,3,3,2], numericOnly: true });
            cpfEl.addEventListener('paste', function() { setTimeout(function(){ try{ cpfMask.destroy(); cpfMask = new Cleave(cpfEl, { delimiters: ['.','.','-'], blocks: [3,3,3,2], numericOnly: true }); }catch(e){} }, 50); });
        }

        if (dataEl) {
            var dataMask = new Cleave(dataEl, { date: true, datePattern: ['d', 'm', 'Y'] });
        }
    } catch (e) {
        console.warn('Cleave init failed', e);
    }
});
</script>

<script>
// Fetch CNPJ data on demand (button) with fallback and inline alerts
document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log('novo_cliente: CNPJ script init');
    } catch (e) {}

    // robustly locate the CNPJ input and the Buscar button using fallbacks
    var cnpjInput = document.getElementById('id_cnpj') || document.querySelector('input[name="cnpj"]') || document.querySelector('input[id$="cnpj"]');
    if (!cnpjInput) {
        console.warn('CNPJ input not found on page');
        return;
    }

    // Apply the same live-formatting used in relatorios: format as 00.000.000/0000-00 while typing/pasting
    function onlyDigits(v){ return (v || '').replace(/\D/g, ''); }
    function formatCNPJ(v){
        v = onlyDigits(v).slice(0,14);
        if (v.length <= 2) return v;
        if (v.length <= 5) return v.slice(0,2) + '.' + v.slice(2);
        if (v.length <= 8) return v.slice(0,2) + '.' + v.slice(2,5) + '.' + v.slice(5);
        if (v.length <= 12) return v.slice(0,2) + '.' + v.slice(2,5) + '.' + v.slice(5,8) + '/' + v.slice(8);
        return v.slice(0,2) + '.' + v.slice(2,5) + '.' + v.slice(5,8) + '/' + v.slice(8,12) + '-' + v.slice(12);
    }
    try {
        cnpjInput.addEventListener('input', function(e){
            try{
                var pos = this.selectionStart || 0;
                var old = this.value || '';
                this.value = formatCNPJ(this.value);
                // try to preserve cursor roughly
                if (this.value.length > old.length) {
                    this.selectionStart = this.selectionEnd = pos + (this.value.length - old.length);
                }
            }catch(err){/* ignore */}
        });
    } catch (e) { console.warn('attach cnpj formatter failed', e); }

    var btnBuscar = document.getElementById('btn-buscar-cnpj') || document.querySelector('button[title*="Buscar"]');
    // ensure button is enabled on load
    try { if (btnBuscar) { btnBuscar.disabled = false; btnBuscar.style.cursor = 'pointer'; } } catch (e) { console.warn(e); }
    var razaoEl = document.getElementById('id_razao_social');
    var fantasiaEl = document.getElementById('id_fantasia');
    var enderecoEl = document.getElementById('id_endereco_completo');
    var alertEl = document.getElementById('cnpj-alert');

    function showAlert(msg, isError) {
        try {
            if (!alertEl) return;
            alertEl.style.display = msg ? '' : 'none';
            alertEl.textContent = msg || '';
            alertEl.classList.toggle('text-danger', !!isError);
            alertEl.classList.toggle('text-success', !isError && !!msg);
        } catch (err) {
            try { console.warn('showAlert error', err); } catch (e) {}
        }
    }

    async function fetchBrasilApi(cnpjDigits) {
        var url = 'https://brasilapi.com.br/api/cnpj/v1/' + cnpjDigits;
        var resp = await fetch(url);
        if (!resp.ok) throw new Error('notfound');
        return resp.json();
    }

    async function fetchReceitaWs(cnpjDigits) {
        // Fallback: receitaws (may be rate limited / CORS-restricted)
        var url = 'https://www.receitaws.com.br/v1/cnpj/' + cnpjDigits;
        var resp = await fetch(url);
        if (!resp.ok) throw new Error('notfound');
        return resp.json();
    }

    async function buscarCnpj() {
        showAlert('', false);
        var digits = (cnpjInput.value || '').replace(/\D/g, '');
        if (digits.length !== 14) {
            showAlert('Digite o CNPJ completo (14 dígitos).', true);
            return;
        }

        btnBuscar && (btnBuscar.disabled = true);
        showAlert('Buscando dados do CNPJ...', false);

        try {
            var data = null;
            try {
                data = await fetchBrasilApi(digits);
            } catch (e) {
                // try fallback
                try {
                    data = await fetchReceitaWs(digits);
                } catch (e2) {
                    throw new Error('notfound');
                }
            }

            // adapt receita.ws schema to brasilapi if needed
            if (data) {
                // Some APIs use different property names
                var razao = data.razao_social || data.nome || '';
                var fantasia = data.fantasia || data.nome_fantasia || '';
                var endereco = '';
                if (data.estabelecimento && data.estabelecimento[0]) {
                    var e = data.estabelecimento[0];
                    var parts = [];
                    if (e.logradouro) parts.push(e.logradouro);
                    if (e.numero) parts.push(e.numero);
                    if (e.complemento) parts.push(e.complemento);
                    if (e.bairro) parts.push(e.bairro);
                    if (e.municipio) parts.push(e.municipio);
                    if (e.uf) parts.push(e.uf);
                    if (e.cep) parts.push(e.cep);
                    endereco = parts.filter(Boolean).join(', ');
                } else if (data.logradouro || data.municipio) {
                    // receita.ws schema
                    var parts2 = [];
                    if (data.logradouro) parts2.push(data.logradouro);
                    if (data.numero) parts2.push(data.numero);
                    if (data.complemento) parts2.push(data.complemento);
                    if (data.bairro) parts2.push(data.bairro);
                    if (data.municipio) parts2.push(data.municipio);
                    if (data.uf) parts2.push(data.uf);
                    if (data.cep) parts2.push(data.cep);
                    endereco = parts2.filter(Boolean).join(', ');
                }

                if (razaoEl && razao) razaoEl.value = razao;
                if (fantasiaEl && fantasia) fantasiaEl.value = fantasia;
                if (enderecoEl && endereco) enderecoEl.value = endereco;

                showAlert('Dados carregados pelo CNPJ.', false);
            } else {
                throw new Error('notfound');
            }
        } catch (err) {
            showAlert('CNPJ não encontrado ou serviço indisponível. Tente novamente mais tarde.', true);
        } finally {
            btnBuscar && (btnBuscar.disabled = false);
        }
    }

    if (btnBuscar) {
        btnBuscar.addEventListener('click', function(ev) {
            try {
                ev.preventDefault();
                btnBuscar.disabled = true;
                btnBuscar.dataset.origHtml = btnBuscar.innerHTML;
                btnBuscar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
            } catch (e) { console.warn(e); }
            buscarCnpj().finally(function() {
                try { btnBuscar.disabled = false; btnBuscar.innerHTML = btnBuscar.dataset.origHtml || '<i class="fas fa-search"></i> Buscar CNPJ'; } catch (xx) {}
            });
        });
    } else {
        console.warn('Buscar CNPJ button not found to attach listener');
    }

    // Fallback delegated listener on document body in case direct binding fails
    document.body.addEventListener('click', function(e) {
        try {
            var el = e.target.closest ? e.target.closest('#btn-buscar-cnpj') : null;
            if (el) {
                e.preventDefault();
                try { el.disabled = true; el.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...'; } catch (xx) {}
                buscarCnpj().finally(function() {
                    try { el.disabled = false; el.innerHTML = '<i class="fas fa-search"></i> Buscar CNPJ'; } catch (xx) {}
                });
            }
        } catch (err) { try { console.warn(err); } catch (e) {} }
    });
});
</script>
