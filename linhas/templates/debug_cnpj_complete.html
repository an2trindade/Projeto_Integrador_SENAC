<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug CNPJ - Teste Completo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .debug { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        input, button { padding: 8px; margin: 5px; }
        button { background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #result { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug Completo - Bot√£o Consultar CNPJ</h1>
    
    <div>
        <label><strong>CNPJ para teste:</strong></label>
        <input type="text" id="cnpj-input" value="19131243000197" placeholder="Digite o CNPJ">
        <button id="btn-test-api" onclick="testCompleteFlow()">üß™ Testar API</button>
        <button id="btn-clear" onclick="clearResults()">üóëÔ∏è Limpar</button>
    </div>
    
    <div id="result"></div>

    <h2>üéØ Teste Simula√ß√£o do Formul√°rio Real</h2>
    <div style="border: 2px dashed #ccc; padding: 20px; margin: 20px 0;">
        <label>CNPJ:</label>
        <input type="text" id="form-cnpj" value="19131243000197">
        <button id="btn-buscar-cnpj" onclick="testRealForm()">üîç Buscar CNPJ</button>
        
        <br><br>
        
        <label>Raz√£o Social:</label>
        <input type="text" id="id_razao_social" readonly style="background: #f9f9f9;">
        
        <br><br>
        
        <label>Fantasia:</label>
        <input type="text" id="id_fantasia" readonly style="background: #f9f9f9;">
        
        <br><br>
        
        <label>Endere√ßo:</label>
        <input type="text" id="id_endereco_completo" readonly style="background: #f9f9f9; width: 100%;">
        
        <div id="cnpj-alert" style="margin-top: 10px; padding: 5px; display: none;"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const result = document.getElementById('result');
            const div = document.createElement('div');
            div.className = 'debug ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '');
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            result.appendChild(div);
            result.scrollTop = result.scrollHeight;
            console.log(message);
        }

        function clearResults() {
            document.getElementById('result').innerHTML = '';
            document.getElementById('id_razao_social').value = '';
            document.getElementById('id_fantasia').value = '';
            document.getElementById('id_endereco_completo').value = '';
            const alert = document.getElementById('cnpj-alert');
            alert.style.display = 'none';
        }

        async function testCompleteFlow() {
            const cnpj = document.getElementById('cnpj-input').value.replace(/\D/g, '');
            const btn = document.getElementById('btn-test-api');
            
            log('üöÄ Iniciando teste completo do fluxo CNPJ');
            log('üìù CNPJ para teste: ' + cnpj);
            
            if (cnpj.length !== 14) {
                log('‚ùå CNPJ deve ter 14 d√≠gitos, atual: ' + cnpj.length, 'error');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Testando...';
            
            try {
                // Teste 1: Verificar se a URL est√° acess√≠vel
                log('üîó Teste 1: Verificando URL da API...');
                const url = '/linhas/buscar-cnpj-api/?cnpj=' + cnpj;
                log('üì° URL: ' + url);
                
                // Teste 2: Fazer a requisi√ß√£o
                log('üì® Teste 2: Fazendo requisi√ß√£o...');
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json',
                    }
                });
                
                log('üìä Status HTTP: ' + response.status + ' ' + response.statusText, 
                    response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log('‚ùå Erro na resposta: ' + errorText, 'error');
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                
                // Teste 3: Processar resposta JSON
                log('üîÑ Teste 3: Processando resposta JSON...');
                const result = await response.json();
                log('üìã Resposta completa: ' + JSON.stringify(result, null, 2), 'success');
                
                // Teste 4: Verificar estrutura da resposta
                log('üîç Teste 4: Verificando estrutura da resposta...');
                if (result.success) {
                    log('‚úÖ API retornou sucesso!', 'success');
                    log('üìÑ Dados recebidos: ' + JSON.stringify(result.dados, null, 2), 'success');
                    
                    // Teste 5: Simular preenchimento de campos
                    log('‚úèÔ∏è Teste 5: Simulando preenchimento de campos...');
                    const data = result.dados;
                    log('üè¢ Nome/Raz√£o Social: ' + (data.razao_social || data.nome || 'N/A'));
                    log('üè™ Fantasia: ' + (data.fantasia || data.nome_fantasia || 'N/A'));
                    log('üìç Endere√ßo: ' + (data.endereco || 'N/A'));
                    log('üåÜ Munic√≠pio: ' + (data.municipio || 'N/A'));
                    log('üî¢ CEP: ' + (data.cep || 'N/A'));
                    log('üåê Fonte: ' + (data.fonte || 'N/A'));
                    
                } else {
                    log('‚ùå API retornou falha: ' + (result.error || 'Erro desconhecido'), 'error');
                }
                
                log('üéâ Teste completo finalizado!', 'success');
                
            } catch (error) {
                log('üí• Erro durante o teste: ' + error.message, 'error');
                log('üîç Stack trace: ' + error.stack, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üß™ Testar API';
            }
        }

        function showAlert(msg, isError) {
            const alertEl = document.getElementById('cnpj-alert');
            if (!alertEl) return;
            alertEl.style.display = msg ? 'block' : 'none';
            alertEl.textContent = msg || '';
            alertEl.style.color = isError ? '#721c24' : '#155724';
            alertEl.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
            alertEl.style.padding = '5px';
            alertEl.style.borderRadius = '4px';
        }

        async function testRealForm() {
            log('üéØ Iniciando teste com formul√°rio real...');
            
            const cnpjInput = document.getElementById('form-cnpj');
            const btnBuscar = document.getElementById('btn-buscar-cnpj');
            const razaoEl = document.getElementById('id_razao_social');
            const fantasiaEl = document.getElementById('id_fantasia');
            const enderecoEl = document.getElementById('id_endereco_completo');
            
            showAlert('', false);
            const digits = (cnpjInput.value || '').replace(/\D/g, '');
            
            log('üìù CNPJ extra√≠do: ' + digits);
            
            if (digits.length !== 14) {
                showAlert('Digite o CNPJ completo (14 d√≠gitos).', true);
                log('‚ùå CNPJ inv√°lido: ' + digits.length + ' d√≠gitos', 'error');
                return;
            }

            btnBuscar.disabled = true;
            btnBuscar.textContent = '‚è≥ Buscando...';
            showAlert('Buscando dados do CNPJ...', false);
            log('üîÑ Iniciando busca...');

            try {
                const url = '/linhas/buscar-cnpj-api/?cnpj=' + digits;
                log('üì° Fazendo requisi√ß√£o para: ' + url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json',
                    }
                });
                
                log('üìä Status da resposta: ' + response.status);
                
                if (!response.ok) {
                    throw new Error('Erro na requisi√ß√£o: ' + response.status);
                }
                
                const result = await response.json();
                log('üìã Resultado da API: ' + JSON.stringify(result, null, 2));
                
                if (!result.success) {
                    throw new Error(result.error || 'CNPJ n√£o encontrado');
                }
                
                const data = result.dados;

                // Preencher campos
                if (razaoEl && data.razao_social) {
                    razaoEl.value = data.razao_social;
                    log('‚úÖ Raz√£o social preenchida: ' + data.razao_social);
                }
                
                if (fantasiaEl && data.fantasia) {
                    fantasiaEl.value = data.fantasia;
                    log('‚úÖ Fantasia preenchida: ' + data.fantasia);
                }
                
                if (enderecoEl) {
                    const endParts = [];
                    if (data.endereco) endParts.push(data.endereco);
                    if (data.numero) endParts.push(data.numero);
                    if (data.complemento) endParts.push(data.complemento);
                    if (data.bairro) endParts.push(data.bairro);
                    if (data.municipio) endParts.push(data.municipio);
                    if (data.uf) endParts.push(data.uf);
                    if (data.cep) endParts.push('CEP: ' + data.cep);
                    const endereco = endParts.join(', ');
                    enderecoEl.value = endereco;
                    log('‚úÖ Endere√ßo preenchido: ' + endereco);
                }
                
                showAlert('Dados carregados com sucesso! Fonte: ' + (data.fonte || 'API'), false);
                log('üéâ Formul√°rio preenchido com sucesso!', 'success');
                
            } catch (error) {
                log('‚ùå Erro ao buscar CNPJ: ' + error.message, 'error');
                showAlert('Erro: ' + error.message, true);
            } finally {
                btnBuscar.disabled = false;
                btnBuscar.textContent = 'üîç Buscar CNPJ';
            }
        }
        
        // Log inicial
        log('üì± P√°gina de debug carregada. JavaScript funcionando!');
        
        // Verificar se o servidor est√° respondendo
        log('üåê Verificando se o servidor est√° respondendo...');
        fetch('/linhas/')
            .then(response => log('‚úÖ Servidor Django respondendo (status: ' + response.status + ')', 'success'))
            .catch(error => log('‚ùå Erro ao conectar com servidor: ' + error.message, 'error'));
    </script>
</body>
</html>